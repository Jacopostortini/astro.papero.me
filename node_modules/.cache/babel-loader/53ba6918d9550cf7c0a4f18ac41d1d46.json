{"remainingRequest":"/media/jacopo/VolumeDati/Documenti/papero.tk/cosmos.papero.me/node_modules/thread-loader/dist/cjs.js!/media/jacopo/VolumeDati/Documenti/papero.tk/cosmos.papero.me/node_modules/babel-loader/lib/index.js!/media/jacopo/VolumeDati/Documenti/papero.tk/cosmos.papero.me/node_modules/eslint-loader/index.js??ref--13-0!/media/jacopo/VolumeDati/Documenti/papero.tk/cosmos.papero.me/src/phaser/GameScene.js","dependencies":[{"path":"/media/jacopo/VolumeDati/Documenti/papero.tk/cosmos.papero.me/src/phaser/GameScene.js","mtime":1618816482175},{"path":"/media/jacopo/VolumeDati/Documenti/papero.tk/cosmos.papero.me/node_modules/cache-loader/dist/cjs.js","mtime":1618298483685},{"path":"/media/jacopo/VolumeDati/Documenti/papero.tk/cosmos.papero.me/node_modules/thread-loader/dist/cjs.js","mtime":1618298485037},{"path":"/media/jacopo/VolumeDati/Documenti/papero.tk/cosmos.papero.me/node_modules/babel-loader/lib/index.js","mtime":1618298483657},{"path":"/media/jacopo/VolumeDati/Documenti/papero.tk/cosmos.papero.me/node_modules/eslint-loader/index.js","mtime":1618298483941}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IF9vYmplY3RTcHJlYWQgZnJvbSAiL21lZGlhL2phY29wby9Wb2x1bWVEYXRpL0RvY3VtZW50aS9wYXBlcm8udGsvY29zbW9zLnBhcGVyby5tZS9ub2RlX21vZHVsZXMvQGJhYmVsL3J1bnRpbWUvaGVscGVycy9lc20vb2JqZWN0U3ByZWFkMiI7CmltcG9ydCBfY3JlYXRlRm9yT2ZJdGVyYXRvckhlbHBlciBmcm9tICIvbWVkaWEvamFjb3BvL1ZvbHVtZURhdGkvRG9jdW1lbnRpL3BhcGVyby50ay9jb3Ntb3MucGFwZXJvLm1lL25vZGVfbW9kdWxlcy9AYmFiZWwvcnVudGltZS9oZWxwZXJzL2VzbS9jcmVhdGVGb3JPZkl0ZXJhdG9ySGVscGVyIjsKaW1wb3J0IF9jbGFzc0NhbGxDaGVjayBmcm9tICIvbWVkaWEvamFjb3BvL1ZvbHVtZURhdGkvRG9jdW1lbnRpL3BhcGVyby50ay9jb3Ntb3MucGFwZXJvLm1lL25vZGVfbW9kdWxlcy9AYmFiZWwvcnVudGltZS9oZWxwZXJzL2VzbS9jbGFzc0NhbGxDaGVjayI7CmltcG9ydCBfY3JlYXRlQ2xhc3MgZnJvbSAiL21lZGlhL2phY29wby9Wb2x1bWVEYXRpL0RvY3VtZW50aS9wYXBlcm8udGsvY29zbW9zLnBhcGVyby5tZS9ub2RlX21vZHVsZXMvQGJhYmVsL3J1bnRpbWUvaGVscGVycy9lc20vY3JlYXRlQ2xhc3MiOwppbXBvcnQgX2luaGVyaXRzIGZyb20gIi9tZWRpYS9qYWNvcG8vVm9sdW1lRGF0aS9Eb2N1bWVudGkvcGFwZXJvLnRrL2Nvc21vcy5wYXBlcm8ubWUvbm9kZV9tb2R1bGVzL0BiYWJlbC9ydW50aW1lL2hlbHBlcnMvZXNtL2luaGVyaXRzIjsKaW1wb3J0IF9jcmVhdGVTdXBlciBmcm9tICIvbWVkaWEvamFjb3BvL1ZvbHVtZURhdGkvRG9jdW1lbnRpL3BhcGVyby50ay9jb3Ntb3MucGFwZXJvLm1lL25vZGVfbW9kdWxlcy9AYmFiZWwvcnVudGltZS9oZWxwZXJzL2VzbS9jcmVhdGVTdXBlciI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5Lm1hcC5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL3dlYi5kb20tY29sbGVjdGlvbnMuZm9yLWVhY2guanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5vYmplY3QuZW50cmllcy5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLm9iamVjdC52YWx1ZXMuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5tYXRoLnNpZ24uanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5udW1iZXIucGFyc2UtZmxvYXQuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5udW1iZXIuY29uc3RydWN0b3IuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5udW1iZXIudG8tZml4ZWQuanMiOwppbXBvcnQgKiBhcyBQaGFzZXIgZnJvbSAicGhhc2VyIjsKaW1wb3J0IHdlYnNvY2tldEV2ZW50cyBmcm9tICIuLi9jb25zdGFudHMvd2Vic29ja2V0RXZlbnRzIjsKaW1wb3J0IHsgZ2FtZURpbWVuc2lvbnMsIGFyY2FkZU5vcm1hbGl6ZXJzLCBwb3dlclVwcywgc2NlbmVLZXlzLCBtYXR0ZXJOb3JtYWxpemVycyB9IGZyb20gIi4uL2NvbnN0YW50cy9nYW1lU2V0dGluZ3MiOwppbXBvcnQgeyBkZXRlY3RUb3VjaFNjcmVlbiwgcmVtb3ZlRnJvbUFycmF5IH0gZnJvbSAiLi4vY29uc3RhbnRzL2NvbnN0YW50cyI7CmltcG9ydCBfIGZyb20gImxvZGFzaCI7CmltcG9ydCBjcmVhdGVNYXAgZnJvbSAiLi4vcGhhc2VyL21hcHMiOwppbXBvcnQgeyBjcmVhdGVCdWxsZXRzTG9hZGVkT2JqZWN0LCBnZXRCb2R5RnJvbUNvbGxpc2lvbiwgbG9hZEltYWdlcywgc2V0SW5wdXRIYW5kbGVycywgdmVsb2NpdHlGcm9tQW5nbGUgfSBmcm9tICIuL3NjZW5lIjsKCnZhciBHYW1lU2NlbmUgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKF9QaGFzZXIkU2NlbmUpIHsKICBfaW5oZXJpdHMoR2FtZVNjZW5lLCBfUGhhc2VyJFNjZW5lKTsKCiAgdmFyIF9zdXBlciA9IF9jcmVhdGVTdXBlcihHYW1lU2NlbmUpOwoKICBmdW5jdGlvbiBHYW1lU2NlbmUoc29ja2V0LCBnYW1lKSB7CiAgICB2YXIgX3RoaXM7CgogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIEdhbWVTY2VuZSk7CgogICAgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzLCB7CiAgICAgIGtleTogc2NlbmVLZXlzLmdhbWUsCiAgICAgIHBoeXNpY3M6IHsKICAgICAgICBkZWZhdWx0OiAibWF0dGVyIiwKICAgICAgICBtYXR0ZXI6IHsKICAgICAgICAgIGRlYnVnOiBmYWxzZSwKICAgICAgICAgIHNldEJvdW5kczogdHJ1ZQogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICBfdGhpcy5zb2NrZXQgPSBzb2NrZXQ7CiAgICBfdGhpcy51cGRhdGVGcHMgPSAxMDsKICAgIF90aGlzLnRvdWNoU2NyZWVuID0gZGV0ZWN0VG91Y2hTY3JlZW4oKTsKICAgIF90aGlzLmRlZmF1bHRJbWFnZU9wdGlvbnMgPSB7CiAgICAgIGZyaWN0aW9uOiAwLAogICAgICBmcmljdGlvbkFpcjogMCwKICAgICAgZnJpY3Rpb25TdGF0aWM6IDAsCiAgICAgIGlnbm9yZUdyYXZpdHk6IHRydWUKICAgIH07CiAgICBfdGhpcy5tYXhCdWxsZXRzID0gMzsKICAgIF90aGlzLnBvd2VyVXBJZHMgPSAwOwogICAgX3RoaXMucG93ZXJVcEdlbmVyYXRpb25UaW1lID0gMTAwMDA7CgogICAgX3RoaXMuc2V0VXBHYW1lKGdhbWUpOwoKICAgIF90aGlzLnNvY2tldC5vbih3ZWJzb2NrZXRFdmVudHMuVVBEQVRFX1NISVAsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgIHJldHVybiBfdGhpcy51cGRhdGVTaGlwKGRhdGEpOwogICAgfSk7CgogICAgX3RoaXMuc29ja2V0Lm9uKHdlYnNvY2tldEV2ZW50cy5TSE9PVCwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgcmV0dXJuIF90aGlzLmNyZWF0ZUJ1bGxldChkYXRhKTsKICAgIH0pOwoKICAgIF90aGlzLnNvY2tldC5vbih3ZWJzb2NrZXRFdmVudHMuQ0hBTkdFX1NUQVRFLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICByZXR1cm4gX3RoaXMudXBkYXRlU3RhdGUoZGF0YSk7CiAgICB9KTsKCiAgICBfdGhpcy5zb2NrZXQub24od2Vic29ja2V0RXZlbnRzLlJFTE9BRCwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgcmV0dXJuIF90aGlzLnJlbG9hZChkYXRhKTsKICAgIH0pOwoKICAgIF90aGlzLnNvY2tldC5vbih3ZWJzb2NrZXRFdmVudHMuUE9XRVJfVVAsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgIHJldHVybiBfdGhpcy5wb3dlclVwRXZlbnQoZGF0YSk7CiAgICB9KTsKCiAgICBfdGhpcy5zb2NrZXQub24od2Vic29ja2V0RXZlbnRzLkVORF9UVVJOLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICBfdGhpcy5jbGVhckludGVydmFscyh0cnVlKTsKCiAgICAgICAgX3RoaXMuc2NlbmUuc3RhcnQoc2NlbmVLZXlzLnJhbmtpbmcsIF8uY2xvbmVEZWVwKGRhdGEpKTsKICAgICAgfSwgMjAwMCk7CiAgICB9KTsKCiAgICByZXR1cm4gX3RoaXM7CiAgfQoKICBfY3JlYXRlQ2xhc3MoR2FtZVNjZW5lLCBbewogICAga2V5OiAic2V0VXBHYW1lIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRVcEdhbWUoZ2FtZSkgewogICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgIHRoaXMudGltZXIgPSBnYW1lLnRpbWVyOwogICAgICB0aGlzLnNldHRpbmdzID0gZ2FtZS5zZXR0aW5nczsKICAgICAgdGhpcy5jdXJyZW50UGxheWVyID0gZ2FtZS5jdXJyZW50UGxheWVyOwogICAgICB0aGlzLmFkbWluID0gZ2FtZS5hZG1pbjsKICAgICAgdGhpcy5tYXAgPSBnYW1lLm1hcDsKICAgICAgdGhpcy5zZXR0aW5ncy5tYXhWZWxvY2l0eUxpdHRsZSA9IGdhbWUuc2V0dGluZ3MudmVsb2NpdHkgKyAwLjI7CiAgICAgIHRoaXMuc2V0dGluZ3MuYWNjZWxlcmF0aW9uTGl0dGxlID0gMC40OwogICAgICB0aGlzLnNldHRpbmdzLnJlc3Bhd25UaW1lID0gODAwMDsKICAgICAgdGhpcy5zZXR0aW5ncy5mcmljdGlvbkFpciA9IDAuMTsKICAgICAgdGhpcy5zZXR0aW5ncy5wb3dlclVwVmVsb2NpdHkgPSAzOwogICAgICB0aGlzLnNldHRpbmdzLnBvd2VyVXBBbmd1bGFyVmVsb2NpdHkgPSAwLjE7CiAgICAgIHRoaXMucGxheWVycyA9IHt9OwogICAgICBnYW1lLnBsYXllcnMuZm9yRWFjaChmdW5jdGlvbiAocGxheWVyKSB7CiAgICAgICAgX3RoaXMyLnBsYXllcnNbcGxheWVyLmxvY2FsSWRdID0gXy5jbG9uZURlZXAocGxheWVyKTsKICAgICAgICBfdGhpczIucGxheWVyc1twbGF5ZXIubG9jYWxJZF0uYXZhaWxhYmxlQnVsbGV0cyA9IF90aGlzMi5tYXhCdWxsZXRzOwogICAgICAgIF90aGlzMi5wbGF5ZXJzW3BsYXllci5sb2NhbElkXS5sYXN0VGltZXN0YW1wID0gMDsKICAgICAgfSk7CiAgICAgIHRoaXMucG93ZXJVcHNPYmplY3RzID0gW107CiAgICB9CiAgfSwgewogICAga2V5OiAiaW5pdCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gaW5pdChnYW1lKSB7CiAgICAgIGNvbnNvbGUubG9nKCJHYW1lIHNjZW5lIGluaXQiLCBfLmNsb25lRGVlcChnYW1lKSk7CiAgICAgIGlmIChPYmplY3QuZW50cmllcyhnYW1lKS5sZW5ndGggPiAwKSB0aGlzLnNldFVwR2FtZShnYW1lKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJwcmVsb2FkIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBwcmVsb2FkKCkgewogICAgICBjb25zb2xlLmxvZygiR2FtZSBzY2VuZSBwcmVsb2FkIik7CiAgICAgIGxvYWRJbWFnZXModGhpcywgc2NlbmVLZXlzLmdhbWUpOwogICAgfQogIH0sIHsKICAgIGtleTogImNyZWF0ZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlKCkgewogICAgICBjb25zb2xlLmxvZygiR2FtZSBzY2VuZSBjcmVhdGUiKTsKCiAgICAgIGlmICh0aGlzLnRpbWVyID4gRGF0ZS5ub3coKSkgewogICAgICAgIHRoaXMuc2NlbmUuc3RvcCgpOwogICAgICAgIHRoaXMuc2NlbmUuc3RhcnQoc2NlbmVLZXlzLnJhbmtpbmcsIF8uY2xvbmVEZWVwKHsKICAgICAgICAgIHBsYXllcnM6IF8uY2xvbmVEZWVwKE9iamVjdC52YWx1ZXModGhpcy5wbGF5ZXJzKSksCiAgICAgICAgICB0aW1lcjogdGhpcy50aW1lcgogICAgICAgIH0pKTsKICAgICAgfQoKICAgICAgY29uc29sZS5sb2coImNvbnRpbnVpbmcgY3JlYXRlIik7CgogICAgICBQaGFzZXIuUGh5c2ljcy5NYXR0ZXIuSW1hZ2UucHJvdG90eXBlLnNoYXBlZFNldE9uQ29sbGlkZSA9IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgIGlmICh0aGlzLmJvZHkgJiYgdGhpcy5ib2R5LnBhcnRzICYmIHRoaXMuYm9keS5wYXJ0cy5sZW5ndGgpIHsKICAgICAgICAgIHZhciBfaXRlcmF0b3IgPSBfY3JlYXRlRm9yT2ZJdGVyYXRvckhlbHBlcih0aGlzLmJvZHkucGFydHMpLAogICAgICAgICAgICAgIF9zdGVwOwoKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGZvciAoX2l0ZXJhdG9yLnMoKTsgIShfc3RlcCA9IF9pdGVyYXRvci5uKCkpLmRvbmU7KSB7CiAgICAgICAgICAgICAgdmFyIHBhcnQgPSBfc3RlcC52YWx1ZTsKICAgICAgICAgICAgICBwYXJ0Lm9uQ29sbGlkZUNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICBfaXRlcmF0b3IuZShlcnIpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgX2l0ZXJhdG9yLmYoKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzLnNldE9uQ29sbGlkZShjYWxsYmFjayk7CiAgICAgIH07CgogICAgICB0aGlzLmpzb25TaGFwZXMgPSB0aGlzLmNhY2hlLmpzb24uZ2V0KCJzaGFwZXMiKTsKICAgICAgdGhpcy5jcmVhdGVDYXRlZ29yaWVzKCk7CiAgICAgIHRoaXMuY3JlYXRlU2hpcHMoKTsKICAgICAgY3JlYXRlTWFwKHRoaXMpOwogICAgICBzZXRJbnB1dEhhbmRsZXJzKHRoaXMsIHNjZW5lS2V5cy5nYW1lKTsKICAgICAgdGhpcy5zZXRSZWxvYWRJbnRlcnZhbCgpOwogICAgICB0aGlzLnNldFVwZGF0ZVNoaXBJbnRlcnZhbCgpOwoKICAgICAgaWYgKHRoaXMuYWRtaW4gPT09IHRoaXMuY3VycmVudFBsYXllcikgewogICAgICAgIHRoaXMuc2V0UG93ZXJVcEludGVydmFsKCk7CiAgICAgICAgdGhpcy5nZW5lcmF0ZVBvd2VyVXAoewogICAgICAgICAgeDogZ2FtZURpbWVuc2lvbnMud2lkdGggLyAyLAogICAgICAgICAgeTogZ2FtZURpbWVuc2lvbnMuaGVpZ2h0IC8gMgogICAgICAgIH0sIDIpOwogICAgICB9CgogICAgICB0aGlzLnNldE9uRGVzdHJveSgpOwogICAgfQogIH0sIHsKICAgIGtleTogInVwZGF0ZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdXBkYXRlKHRpbWUsIGRlbHRhKSB7CiAgICAgIHZhciBfdGhpczMgPSB0aGlzOwoKICAgICAgaWYgKHRoaXMuY3VycmVudFBsYXllciAhPT0gbnVsbCAmJiB0aGlzLnBsYXllcnNbdGhpcy5jdXJyZW50UGxheWVyXS5zaGlwLmJvZHkpIHsKICAgICAgICBpZiAodGhpcy5yb3RhdGlvbktleS5pc0Rvd24gfHwgdGhpcy5yb3RhdGluZykgdGhpcy5yb3RhdGUoZGVsdGEpOwogICAgICAgIGlmICh0aGlzLmFjY2VsZXJhdGVMaXR0bGVLZXkuaXNEb3duIHx8IHRoaXMuYWNjZWxlcmF0aW5nKSB0aGlzLm1vdmVMaXR0bGUoZGVsdGEpOwogICAgICAgIHRoaXMuc2V0Q3VycmVudFBsYXllck5ld1ZlbG9jaXR5KCk7CiAgICAgICAgaWYgKHRoaXMucGxheWVyc1t0aGlzLmN1cnJlbnRQbGF5ZXJdLnN0YXRlID09PSAxKSB0aGlzLmRlY2VsZXJhdGVMaXR0bGUoZGVsdGEpOwogICAgICB9CgogICAgICBPYmplY3QudmFsdWVzKHRoaXMucGxheWVycykuZm9yRWFjaChmdW5jdGlvbiAocGxheWVyKSB7CiAgICAgICAgaWYgKCFwbGF5ZXIuc2hpcC5ib2R5KSByZXR1cm47CiAgICAgICAgdmFyIHRvcExlZnQgPSBwbGF5ZXIuc2hpcC5nZXRUb3BMZWZ0KCk7CiAgICAgICAgdmFyIGJvdHRvbUxlZnQgPSBwbGF5ZXIuc2hpcC5nZXRCb3R0b21MZWZ0KCk7CiAgICAgICAgdmFyIGNlbnRlckxlZnQgPSB7CiAgICAgICAgICB4OiAodG9wTGVmdC54ICsgYm90dG9tTGVmdC54KSAvIDIsCiAgICAgICAgICB5OiAodG9wTGVmdC55ICsgYm90dG9tTGVmdC55KSAvIDIKICAgICAgICB9OwogICAgICAgIHBsYXllci5idWxsZXRzTG9hZGVkLmdhbWVPYmplY3RzLmZvckVhY2goZnVuY3Rpb24gKGJ1bGxldCwgaW5kZXgpIHsKICAgICAgICAgIHZhciBfdGhpczMkZ2V0TG9hZGVkQnVsbGUgPSBfdGhpczMuZ2V0TG9hZGVkQnVsbGV0UG9zaXRpb24oaW5kZXgsIHRvcExlZnQsIGJvdHRvbUxlZnQsIGNlbnRlckxlZnQsIHBsYXllciksCiAgICAgICAgICAgICAgeCA9IF90aGlzMyRnZXRMb2FkZWRCdWxsZS54LAogICAgICAgICAgICAgIHkgPSBfdGhpczMkZ2V0TG9hZGVkQnVsbGUueTsKCiAgICAgICAgICBidWxsZXQueCA9IHg7CiAgICAgICAgICBidWxsZXQueSA9IHk7CiAgICAgICAgfSk7CgogICAgICAgIGlmIChwbGF5ZXIubG9jYWxJZCAhPT0gX3RoaXMzLmN1cnJlbnRQbGF5ZXIpIHsKICAgICAgICAgIHBsYXllci5zaGlwLmF1dG9ub215VGltZSAtPSBkZWx0YTsKCiAgICAgICAgICBpZiAocGxheWVyLnNoaXAuYXV0b25vbXlUaW1lIDwgMCkgewogICAgICAgICAgICBwbGF5ZXIuc2hpcC5zZXRWZWxvY2l0eSgwKTsKICAgICAgICAgICAgcGxheWVyLnNoaXAuc2V0QW5ndWxhclZlbG9jaXR5KDApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9IC8vPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAgIC8vQ3JlYXRpbmcgdGhpbmdzCgogIH0sIHsKICAgIGtleTogImNyZWF0ZUNhdGVnb3JpZXMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGNyZWF0ZUNhdGVnb3JpZXMoKSB7CiAgICAgIHRoaXMuc2hpcHNDYXRlZ29yeSA9IDI7CiAgICAgIHRoaXMuYnVsbGV0c0NhdGVnb3J5ID0gNDsKICAgICAgdGhpcy5wb3dlclVwc0NhdGVnb3J5ID0gODsKICAgICAgdGhpcy5tYXBPYmplY3RDYXRlZ29yeSA9IDE2OwogICAgfQogIH0sIHsKICAgIGtleTogImNyZWF0ZVNoaXBzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBjcmVhdGVTaGlwcygpIHsKICAgICAgdmFyIF90aGlzNCA9IHRoaXM7CgogICAgICB2YXIgb3JkZXIgPSBbMCwgMywgMiwgMV07CiAgICAgIHZhciBpbmRleCA9IDA7CiAgICAgIHZhciB0ZXh0dXJlcyA9IFsiIiwgImxpdHRsZSIsICJzaGlwIiwgInNoaWVsZGVkIl07CiAgICAgIE9iamVjdC52YWx1ZXModGhpcy5wbGF5ZXJzKS5mb3JFYWNoKGZ1bmN0aW9uIChwbGF5ZXIpIHsKICAgICAgICBpZiAocGxheWVyLnN0YXRlID09PSAwKSByZXR1cm47CiAgICAgICAgcGxheWVyLnNoaXAgPSBfdGhpczQubWF0dGVyLmFkZC5pbWFnZShvcmRlcltpbmRleF0gPCAyID8gMzAgOiBnYW1lRGltZW5zaW9ucy53aWR0aCAtIDMwLCBvcmRlcltpbmRleF0gJSAyID09PSAwID8gMzAgOiBnYW1lRGltZW5zaW9ucy5oZWlnaHQgLSAzMCwgdGV4dHVyZXNbcGxheWVyLnN0YXRlXSArIHBsYXllci5jb2xvciwgbnVsbCwgX29iamVjdFNwcmVhZChfb2JqZWN0U3ByZWFkKHt9LCBfdGhpczQuZGVmYXVsdEltYWdlT3B0aW9ucyksIHt9LCB7CiAgICAgICAgICBzaGFwZTogX3RoaXM0Lmpzb25TaGFwZXMuc2hpcAogICAgICAgIH0pKTsKICAgICAgICBwbGF5ZXIuc2hpcC5zZXRDb2xsaXNpb25DYXRlZ29yeShfdGhpczQuc2hpcHNDYXRlZ29yeSk7CiAgICAgICAgcGxheWVyLnNoaXAuc2V0QW5nbGUoLTQ1ICogKG9yZGVyW2luZGV4XSA8IDIgPyAxIDogMykgKiAob3JkZXJbaW5kZXhdICUgMiAqIDIgLSAxKSk7CiAgICAgICAgcGxheWVyLnNoaXAudmVsb2NpdHlNYWduaXR1ZGUgPSBfdGhpczQuc2V0dGluZ3MudmVsb2NpdHkgKiBtYXR0ZXJOb3JtYWxpemVycy52ZWxvY2l0eTsKICAgICAgICBwbGF5ZXIuc2hpcC5sb2NhbElkID0gcGxheWVyLmxvY2FsSWQ7CiAgICAgICAgcGxheWVyLnNoaXAuYXV0b25vbXlUaW1lID0gMDsKCiAgICAgICAgX3RoaXM0Lm1hdHRlci5ib2R5LnNldEluZXJ0aWEocGxheWVyLnNoaXAuYm9keSwgSW5maW5pdHkpOwoKICAgICAgICBwbGF5ZXIuYnVsbGV0c0xvYWRlZCA9IGNyZWF0ZUJ1bGxldHNMb2FkZWRPYmplY3QoX3RoaXM0KTsKCiAgICAgICAgaWYgKHBsYXllci5sb2NhbElkID09PSBfdGhpczQuY3VycmVudFBsYXllcikgewogICAgICAgICAgcGxheWVyLnNoaXAuc2hhcGVkU2V0T25Db2xsaWRlKGZ1bmN0aW9uIChjb2xsaXNpb24pIHsKICAgICAgICAgICAgX3RoaXM0Lm9uQ3VycmVudFNoaXBDb2xsaXNpb24oY29sbGlzaW9uKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgaW5kZXgrKzsKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAiY3JlYXRlQnVsbGV0IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBjcmVhdGVCdWxsZXQoZGF0YSkgewogICAgICB2YXIgX3ZlbG9jaXR5RnJvbUFuZ2xlID0gdmVsb2NpdHlGcm9tQW5nbGUoZGF0YS5hbmdsZSwgdGhpcy5zZXR0aW5ncy5idWxsZXRWZWxvY2l0eSAqIG1hdHRlck5vcm1hbGl6ZXJzLmJ1bGxldFZlbG9jaXR5KSwKICAgICAgICAgIHggPSBfdmVsb2NpdHlGcm9tQW5nbGUueCwKICAgICAgICAgIHkgPSBfdmVsb2NpdHlGcm9tQW5nbGUueTsKCiAgICAgIHZhciBidWxsZXQgPSB0aGlzLm1hdHRlci5hZGQuaW1hZ2UoZGF0YS5wb3NpdGlvbi54LCBkYXRhLnBvc2l0aW9uLnksICJidWxsZXQiLCBudWxsLCB0aGlzLmRlZmF1bHRJbWFnZU9wdGlvbnMpOwogICAgICBidWxsZXQuc2V0Q29sbGlzaW9uQ2F0ZWdvcnkodGhpcy5idWxsZXRzQ2F0ZWdvcnkpOwogICAgICBidWxsZXQuc2V0Q29sbGlkZXNXaXRoKFsxLCB0aGlzLnNoaXBzQ2F0ZWdvcnksIHRoaXMubWFwT2JqZWN0Q2F0ZWdvcnldKTsKICAgICAgYnVsbGV0LnNldE9uQ29sbGlkZShmdW5jdGlvbiAoKSB7CiAgICAgICAgYnVsbGV0LmRlc3Ryb3koKTsKICAgICAgfSk7CiAgICAgIGJ1bGxldC5zZXRBbmdsZShkYXRhLmFuZ2xlKTsKICAgICAgYnVsbGV0LnNldFZlbG9jaXR5KHgsIHkpOwogICAgICBidWxsZXQuc2hvdEJ5ID0gZGF0YS5sb2NhbElkOwogICAgICB0aGlzLnBsYXllcnNbZGF0YS5sb2NhbElkXS5hdmFpbGFibGVCdWxsZXRzLS07CiAgICAgIHRoaXMucGxheWVyc1tkYXRhLmxvY2FsSWRdLmJ1bGxldHNMb2FkZWQua2lsbEZpcnN0QWxpdmUoKTsKICAgICAgdGhpcy5tYXR0ZXIuYm9keS5zZXRJbmVydGlhKGJ1bGxldC5ib2R5LCBJbmZpbml0eSk7CiAgICB9CiAgfSwgewogICAga2V5OiAiY3JlYXRlUG93ZXJVcCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlUG93ZXJVcChkYXRhKSB7CiAgICAgIHZhciBuZXdQb3dlclVwID0gdGhpcy5tYXR0ZXIuYWRkLmltYWdlKGRhdGEucG9zaXRpb24ueCwgZGF0YS5wb3NpdGlvbi55LCBkYXRhLnBvd2VyVXAsIG51bGwsIF9vYmplY3RTcHJlYWQoX29iamVjdFNwcmVhZCh7fSwgdGhpcy5kZWZhdWx0SW1hZ2VPcHRpb25zKSwge30sIHsKICAgICAgICBzaGFwZTogdGhpcy5qc29uU2hhcGVzW2RhdGEucG93ZXJVcF0KICAgICAgfSkpOwoKICAgICAgdmFyIF92ZWxvY2l0eUZyb21BbmdsZTIgPSB2ZWxvY2l0eUZyb21BbmdsZShkYXRhLmFuZ2xlLCB0aGlzLnNldHRpbmdzLnBvd2VyVXBWZWxvY2l0eSksCiAgICAgICAgICB4ID0gX3ZlbG9jaXR5RnJvbUFuZ2xlMi54LAogICAgICAgICAgeSA9IF92ZWxvY2l0eUZyb21BbmdsZTIueTsKCiAgICAgIG5ld1Bvd2VyVXAuc2V0VmVsb2NpdHkoeCwgeSk7CiAgICAgIG5ld1Bvd2VyVXAuc2V0QW5ndWxhclZlbG9jaXR5KHRoaXMuc2V0dGluZ3MucG93ZXJVcEFuZ3VsYXJWZWxvY2l0eSk7CiAgICAgIG5ld1Bvd2VyVXAucG93ZXJVcCA9IGRhdGEucG93ZXJVcDsKICAgICAgbmV3UG93ZXJVcC5zZXRDb2xsaXNpb25DYXRlZ29yeSh0aGlzLnBvd2VyVXBzQ2F0ZWdvcnkpOwogICAgICBuZXdQb3dlclVwLnNldENvbGxpZGVzV2l0aChbMSwgdGhpcy5zaGlwc0NhdGVnb3J5LCB0aGlzLm1hcE9iamVjdENhdGVnb3J5XSk7CiAgICAgIG5ld1Bvd2VyVXAuaWQgPSBkYXRhLmlkOwogICAgICB0aGlzLm1hdHRlci5ib2R5LnNldEluZXJ0aWEobmV3UG93ZXJVcC5ib2R5LCBJbmZpbml0eSk7CiAgICAgIHRoaXMucG93ZXJVcHNPYmplY3RzLnB1c2gobmV3UG93ZXJVcCk7CiAgICB9CiAgfSwgewogICAga2V5OiAiY3JlYXRlTGFzZXIiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGNyZWF0ZUxhc2VyKGRhdGEpIHsKICAgICAgdmFyIF90aGlzNSA9IHRoaXM7CgogICAgICB2YXIgbWF4TGVuZ3RoID0gUGhhc2VyLk1hdGguRGlzdGFuY2UuQmV0d2VlbigwLCAwLCBnYW1lRGltZW5zaW9ucy53aWR0aCwgZ2FtZURpbWVuc2lvbnMuaGVpZ2h0KTsKICAgICAgdmFyIGxhc2VyID0gdGhpcy5tYXR0ZXIuYWRkLmltYWdlKGRhdGEucG9zaXRpb24ueCwgZGF0YS5wb3NpdGlvbi55LCAiYnVsbGV0IiwgbnVsbCwgdGhpcy5kZWZhdWx0SW1hZ2VPcHRpb25zKTsKICAgICAgbGFzZXIuc2V0U2NhbGUobWF4TGVuZ3RoIC8gbGFzZXIud2lkdGgsIDEpOwogICAgICBsYXNlci5zZXRTZW5zb3IodHJ1ZSk7CiAgICAgIGxhc2VyLnNldEFuZ2xlKGRhdGEuYW5nbGUpOwogICAgICBsYXNlci5zZXRQb3NpdGlvbihsYXNlci54ICsgbWF4TGVuZ3RoIC8gMiAqIE1hdGguY29zKGRhdGEuYW5nbGUgKiBNYXRoLlBJIC8gMTgwKSwgbGFzZXIueSArIG1heExlbmd0aCAvIDIgKiBNYXRoLnNpbihkYXRhLmFuZ2xlICogTWF0aC5QSSAvIDE4MCkpOwogICAgICBsYXNlci5zZXRDb2xsaWRlc1dpdGgoW3RoaXMuc2hpcHNDYXRlZ29yeSwgdGhpcy5tYXBPYmplY3RDYXRlZ29yeV0pOwogICAgICBsYXNlci5zZXRPbkNvbGxpZGUoZnVuY3Rpb24gKGNvbGxpc2lvbikgewogICAgICAgIHZhciBib2R5ID0gZ2V0Qm9keUZyb21Db2xsaXNpb24obGFzZXIuYm9keS5pZCwgY29sbGlzaW9uKTsKCiAgICAgICAgaWYgKGJvZHkucGFyZW50LmNvbGxpc2lvbkZpbHRlci5jYXRlZ29yeSA9PT0gX3RoaXM1LnNoaXBzQ2F0ZWdvcnkpIHsKICAgICAgICAgIHZhciBkYXRhVG9TZW5kID0gewogICAgICAgICAgICBsb2NhbElkOiBib2R5LnBhcmVudC5nYW1lT2JqZWN0LmxvY2FsSWQsCiAgICAgICAgICAgIHN0YXRlOiAwLAogICAgICAgICAgICBraWxsZWRCeTogZGF0YS5sb2NhbElkCiAgICAgICAgICB9OwoKICAgICAgICAgIF90aGlzNS5jbGVhckludGVydmFscyhmYWxzZSk7CgogICAgICAgICAgX3RoaXM1LnNvY2tldC5lbWl0KHdlYnNvY2tldEV2ZW50cy5DSEFOR0VfU1RBVEUsIGRhdGFUb1NlbmQpOwoKICAgICAgICAgIF90aGlzNS51cGRhdGVTdGF0ZShkYXRhVG9TZW5kKTsKICAgICAgICB9IGVsc2UgaWYgKGJvZHkuY29sbGlzaW9uRmlsdGVyLmNhdGVnb3J5ID09PSBfdGhpczUubWFwT2JqZWN0Q2F0ZWdvcnkpIHsKICAgICAgICAgIGlmIChib2R5LmdhbWVPYmplY3Qua2lsbGFibGUpIGJvZHkuZ2FtZU9iamVjdC5kZXN0cm95KCk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgdGhpcy5tYXR0ZXIuYm9keS5zZXRNYXNzKGxhc2VyLmJvZHksIEluZmluaXR5KTsKICAgICAgdGhpcy5wbGF5ZXJzW2RhdGEubG9jYWxJZF0uc2hpcC5zZXRUb1NsZWVwKCk7CiAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgIGxhc2VyLmRlc3Ryb3koKTsKCiAgICAgICAgX3RoaXM1LnBsYXllcnNbZGF0YS5sb2NhbElkXS5zaGlwLnNldEF3YWtlKCk7CiAgICAgIH0sIDUwMCk7CiAgICB9CiAgfSwgewogICAga2V5OiAiZ2VuZXJhdGVQb3dlclVwIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBnZW5lcmF0ZVBvd2VyVXAoX3JlZikgewogICAgICB2YXIgeCA9IF9yZWYueCwKICAgICAgICAgIHkgPSBfcmVmLnk7CiAgICAgIHZhciBuID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiAxOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuOyBpKyspIHsKICAgICAgICB2YXIgZGF0YSA9IHsKICAgICAgICAgIHR5cGU6ICJjcmVhdGUiLAogICAgICAgICAgcG93ZXJVcDogcG93ZXJVcHNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogcG93ZXJVcHMubGVuZ3RoKV0sCiAgICAgICAgICBwb3NpdGlvbjogewogICAgICAgICAgICB4OiB4IHx8IFBoYXNlci5NYXRoLkZsb2F0QmV0d2VlbigwLCBnYW1lRGltZW5zaW9ucy53aWR0aCksCiAgICAgICAgICAgIHk6IHkgfHwgUGhhc2VyLk1hdGguRmxvYXRCZXR3ZWVuKDAsIGdhbWVEaW1lbnNpb25zLmhlaWdodCkKICAgICAgICAgIH0sCiAgICAgICAgICBhbmdsZTogUGhhc2VyLk1hdGguRmxvYXRCZXR3ZWVuKDAsIDM2MCksCiAgICAgICAgICBpZDogKyt0aGlzLnBvd2VyVXBJZHMKICAgICAgICB9OwogICAgICAgIHRoaXMuc29ja2V0LmVtaXQod2Vic29ja2V0RXZlbnRzLlBPV0VSX1VQLCBkYXRhKTsKICAgICAgICB0aGlzLnBvd2VyVXBFdmVudChkYXRhKTsKICAgICAgfQogICAgfSAvLz09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgICAvL090aGVycyBkbyB0aGluZ3MgdmlhIHRoZSB3ZWJzb2NrZXQKCiAgfSwgewogICAga2V5OiAidXBkYXRlU2hpcCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdXBkYXRlU2hpcChkYXRhKSB7CiAgICAgIHZhciBwbGF5ZXIgPSB0aGlzLnBsYXllcnNbZGF0YVswXV07CiAgICAgIGlmICghcGxheWVyLnNoaXApIHJldHVybjsKICAgICAgdmFyIGRlbHRhTWlsbGlzZWNvbmRzID0gZGF0YVszXSAtIHBsYXllci5sYXN0VGltZXN0YW1wOwogICAgICB2YXIgZGVsdGFVbml0cyA9IGRlbHRhTWlsbGlzZWNvbmRzICogNjAgLyAxMDAwOwogICAgICBpZiAoZGVsdGFNaWxsaXNlY29uZHMgPD0gMCkgcmV0dXJuOwogICAgICB2YXIgZGVsdGFUaGV0YSA9IGRhdGFbMV0gLSBNYXRoLmZsb29yKHBsYXllci5zaGlwLmFuZ2xlKTsKICAgICAgaWYgKGRlbHRhVGhldGEgKiBNYXRoLnNpZ24odGhpcy5zZXR0aW5ncy5hbmd1bGFyVmVsb2NpdHkpIDwgLTEwKSBkZWx0YVRoZXRhICs9IDM2MCAqIE1hdGguc2lnbih0aGlzLnNldHRpbmdzLmFuZ3VsYXJWZWxvY2l0eSk7ZWxzZSBpZiAoZGVsdGFUaGV0YSAqIE1hdGguc2lnbih0aGlzLnNldHRpbmdzLmFuZ3VsYXJWZWxvY2l0eSkgPCAwKSBkZWx0YVRoZXRhID0gMDsKICAgICAgdmFyIGFuZ3VsYXJWZWxvY2l0eSA9IGRlbHRhVGhldGEgLyBkZWx0YVVuaXRzOwogICAgICBwbGF5ZXIuc2hpcC5zZXRBbmd1bGFyVmVsb2NpdHkoYW5ndWxhclZlbG9jaXR5ICogTWF0aC5QSSAvIDE4MCk7CiAgICAgIHBsYXllci5zaGlwLnNldFZlbG9jaXR5KChkYXRhWzJdWzBdIC0gcGxheWVyLnNoaXAueCkgLyBkZWx0YVVuaXRzLCAoZGF0YVsyXVsxXSAtIHBsYXllci5zaGlwLnkpIC8gZGVsdGFVbml0cyk7CiAgICAgIHBsYXllci5sYXN0VGltZXN0YW1wID0gZGF0YVszXTsKICAgICAgcGxheWVyLnNoaXAuYXV0b25vbXlUaW1lID0gZGVsdGFNaWxsaXNlY29uZHM7CiAgICB9CiAgfSwgewogICAga2V5OiAicG93ZXJVcEV2ZW50IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBwb3dlclVwRXZlbnQoZGF0YSkgewogICAgICAvL0NyZWF0ZSBwb3dlciB1cCBpdGVtCiAgICAgIGlmIChkYXRhLnR5cGUgPT09ICJjcmVhdGUiKSB0aGlzLmNyZWF0ZVBvd2VyVXAoZGF0YSk7IC8vUGxheWVyIGdldHMgcG93ZXIgdXAKICAgICAgZWxzZSBpZiAoZGF0YS50eXBlID09PSAiZ2V0IikgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLnBvd2VyVXBzT2JqZWN0cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgY2hpbGQgPSB0aGlzLnBvd2VyVXBzT2JqZWN0c1tpXTsKCiAgICAgICAgICAgIGlmIChjaGlsZC5pZCA9PT0gZGF0YS5pZCkgewogICAgICAgICAgICAgIHRoaXMucG93ZXJVcHNPYmplY3RzID0gcmVtb3ZlRnJvbUFycmF5KHRoaXMucG93ZXJVcHNPYmplY3RzLCBpKTsKICAgICAgICAgICAgICBjaGlsZC5kZXN0cm95KCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgZGF0YVRvU2VuZDsKCiAgICAgICAgICBzd2l0Y2ggKGRhdGEucG93ZXJVcCkgewogICAgICAgICAgICBjYXNlICJyZXZlcnNlIjoKICAgICAgICAgICAgICB0aGlzLnNldHRpbmdzLmFuZ3VsYXJWZWxvY2l0eSAqPSAtMTsKICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgInNoaWVsZCI6CiAgICAgICAgICAgICAgZGF0YVRvU2VuZCA9IHsKICAgICAgICAgICAgICAgIGxvY2FsSWQ6IGRhdGEubG9jYWxJZCwKICAgICAgICAgICAgICAgIHN0YXRlOiAzCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB0aGlzLnNvY2tldC5lbWl0KHdlYnNvY2tldEV2ZW50cy5DSEFOR0VfU1RBVEUsIGRhdGFUb1NlbmQpOwogICAgICAgICAgICAgIHRoaXMudXBkYXRlU3RhdGUoZGF0YVRvU2VuZCk7CiAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlICJyZWxvYWQiOgogICAgICAgICAgICAgIGRhdGFUb1NlbmQgPSB7CiAgICAgICAgICAgICAgICBsb2NhbElkOiBkYXRhLmxvY2FsSWQsCiAgICAgICAgICAgICAgICBhdmFpbGFibGVCdWxsZXRzOiB0aGlzLm1heEJ1bGxldHMKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHRoaXMuc29ja2V0LmVtaXQod2Vic29ja2V0RXZlbnRzLlJFTE9BRCwgZGF0YVRvU2VuZCk7CiAgICAgICAgICAgICAgdGhpcy5yZWxvYWQoZGF0YVRvU2VuZCk7CiAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlICJsYXNlciI6CiAgICAgICAgICAgICAgdGhpcy5wbGF5ZXJzW2RhdGEubG9jYWxJZF0uc2hpcC5oYXNMYXNlciA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfSAvL1BsYXllciB1c2VzIHBvd2VyIHVwCiAgICAgICAgZWxzZSBpZiAoZGF0YS50eXBlID09PSAidXNlIikgewogICAgICAgICAgICBpZiAoZGF0YS5wb3dlclVwID09PSAibGFzZXIiKSB0aGlzLmNyZWF0ZUxhc2VyKGRhdGEpOwogICAgICAgICAgfQogICAgfSAvLz09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgICAvL0N1cnJlbnQgcGxheWVycyBkb2VzIHRoaW5ncwoKICB9LCB7CiAgICBrZXk6ICJyb3RhdGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJvdGF0ZShkZWx0YSkgewogICAgICB0aGlzLnBsYXllcnNbdGhpcy5jdXJyZW50UGxheWVyXS5zaGlwLnNldEFuZ2xlKHRoaXMucGxheWVyc1t0aGlzLmN1cnJlbnRQbGF5ZXJdLnNoaXAuYW5nbGUgKyBkZWx0YSAqIHRoaXMuc2V0dGluZ3MuYW5ndWxhclZlbG9jaXR5ICogbWF0dGVyTm9ybWFsaXplcnMuYW5ndWxhclZlbG9jaXR5KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJtb3ZlTGl0dGxlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBtb3ZlTGl0dGxlKGRlbHRhKSB7CiAgICAgIHZhciBjdXJyZW50UGxheWVyID0gdGhpcy5wbGF5ZXJzW3RoaXMuY3VycmVudFBsYXllcl07CgogICAgICBpZiAoY3VycmVudFBsYXllci5zdGF0ZSA9PT0gMSkgewogICAgICAgIHZhciBzaGlwID0gY3VycmVudFBsYXllci5zaGlwOwogICAgICAgIHZhciBwcmV2aW91c01hZyA9IHNoaXAudmVsb2NpdHlNYWduaXR1ZGU7CgogICAgICAgIGlmIChwcmV2aW91c01hZyA8IHRoaXMuc2V0dGluZ3MubWF4VmVsb2NpdHlMaXR0bGUgKiBtYXR0ZXJOb3JtYWxpemVycy52ZWxvY2l0eSkgewogICAgICAgICAgY3VycmVudFBsYXllci5zaGlwLnZlbG9jaXR5TWFnbml0dWRlICs9IGRlbHRhICogdGhpcy5zZXR0aW5ncy5hY2NlbGVyYXRpb25MaXR0bGU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGN1cnJlbnRQbGF5ZXIuc2hpcC52ZWxvY2l0eU1hZ25pdHVkZSA9IHRoaXMuc2V0dGluZ3MubWF4VmVsb2NpdHlMaXR0bGUgKiBtYXR0ZXJOb3JtYWxpemVycy52ZWxvY2l0eTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICJzaG9vdCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2hvb3QoKSB7CiAgICAgIHZhciBjdXJyZW50UGxheWVyID0gdGhpcy5wbGF5ZXJzW3RoaXMuY3VycmVudFBsYXllcl07CiAgICAgIHZhciBzaGlwID0gY3VycmVudFBsYXllci5zaGlwOwogICAgICB2YXIgYW5nbGUgPSBzaGlwLmFuZ2xlOwogICAgICB2YXIgZGF0YSA9IHsKICAgICAgICBwb3NpdGlvbjogewogICAgICAgICAgeDogc2hpcC54ICsgc2hpcC53aWR0aCAqIDUgLyA0ICogTWF0aC5jb3MoYW5nbGUgKiBNYXRoLlBJIC8gMTgwKSwKICAgICAgICAgIHk6IHNoaXAueSArIHNoaXAuaGVpZ2h0ICogNSAvIDQgKiBNYXRoLnNpbihhbmdsZSAqIE1hdGguUEkgLyAxODApCiAgICAgICAgfSwKICAgICAgICBhbmdsZTogYW5nbGUsCiAgICAgICAgbG9jYWxJZDogdGhpcy5jdXJyZW50UGxheWVyCiAgICAgIH07CgogICAgICBpZiAoY3VycmVudFBsYXllci5zaGlwLmhhc0xhc2VyKSB7CiAgICAgICAgZGF0YS50eXBlID0gInVzZSI7CiAgICAgICAgZGF0YS5wb3dlclVwID0gImxhc2VyIjsKICAgICAgICB0aGlzLnNvY2tldC5lbWl0KHdlYnNvY2tldEV2ZW50cy5QT1dFUl9VUCwgZGF0YSk7CiAgICAgICAgdGhpcy5jcmVhdGVMYXNlcihkYXRhKTsKICAgICAgICBjdXJyZW50UGxheWVyLnNoaXAuaGFzTGFzZXIgPSBmYWxzZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoY3VycmVudFBsYXllci5hdmFpbGFibGVCdWxsZXRzID4gMCkgewogICAgICAgICAgdGhpcy5zb2NrZXQuZW1pdCh3ZWJzb2NrZXRFdmVudHMuU0hPT1QsIGRhdGEpOwogICAgICAgICAgdGhpcy5jcmVhdGVCdWxsZXQoZGF0YSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAidXBkYXRlU3RhdGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHVwZGF0ZVN0YXRlKGRhdGEpIHsKICAgICAgdmFyIF90aGlzNiA9IHRoaXM7CgogICAgICB0aGlzLnBsYXllcnNbZGF0YS5sb2NhbElkXS5zdGF0ZSA9IGRhdGEuc3RhdGU7CiAgICAgIHZhciBwbGF5ZXIgPSB0aGlzLnBsYXllcnNbZGF0YS5sb2NhbElkXTsKCiAgICAgIHN3aXRjaCAoZGF0YS5zdGF0ZSkgewogICAgICAgIGNhc2UgMDoKICAgICAgICAgIHBsYXllci5zaGlwLmRlc3Ryb3koKTsKICAgICAgICAgIHRoaXMucGxheWVyc1tkYXRhLmxvY2FsSWRdLmJ1bGxldHNMb2FkZWQua2lsbEFsbCgpOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgMToKICAgICAgICAgIHBsYXllci5zaGlwLnNldFRleHR1cmUoImxpdHRsZSIgKyB0aGlzLnBsYXllcnNbZGF0YS5sb2NhbElkXS5jb2xvcik7CiAgICAgICAgICB0aGlzLnBsYXllcnNbZGF0YS5sb2NhbElkXS5idWxsZXRzTG9hZGVkLmtpbGxBbGwoKTsKCiAgICAgICAgICBpZiAoZGF0YS5sb2NhbElkID09PSB0aGlzLmN1cnJlbnRQbGF5ZXIpIHsKICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgaWYgKF90aGlzNi5wbGF5ZXJzW2RhdGEubG9jYWxJZF0uc3RhdGUgPT09IDEpIHsKICAgICAgICAgICAgICAgIHZhciBfZGF0YSA9IHsKICAgICAgICAgICAgICAgICAgbG9jYWxJZDogX3RoaXM2LmN1cnJlbnRQbGF5ZXIsCiAgICAgICAgICAgICAgICAgIHN0YXRlOiAyCiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIF90aGlzNi51cGRhdGVTdGF0ZShfZGF0YSk7CgogICAgICAgICAgICAgICAgX3RoaXM2LnNvY2tldC5lbWl0KHdlYnNvY2tldEV2ZW50cy5DSEFOR0VfU1RBVEUsIF9kYXRhKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHRoaXMuc2V0dGluZ3MucmVzcGF3blRpbWUpOwogICAgICAgICAgfQoKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlIDI6CiAgICAgICAgICBwbGF5ZXIuc2hpcC52ZWxvY2l0eU1hZ25pdHVkZSA9IHRoaXMuc2V0dGluZ3MudmVsb2NpdHkgKiBtYXR0ZXJOb3JtYWxpemVycy52ZWxvY2l0eTsKICAgICAgICAgIHBsYXllci5zaGlwLnNldFRleHR1cmUoInNoaXAiICsgdGhpcy5wbGF5ZXJzW2RhdGEubG9jYWxJZF0uY29sb3IpOwogICAgICAgICAgcGxheWVyLmJ1bGxldHNMb2FkZWQuZW5hYmxlQWxsKCk7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAzOgogICAgICAgICAgcGxheWVyLnNoaXAudmVsb2NpdHlNYWduaXR1ZGUgPSB0aGlzLnNldHRpbmdzLnZlbG9jaXR5ICogbWF0dGVyTm9ybWFsaXplcnMudmVsb2NpdHk7CiAgICAgICAgICBwbGF5ZXIuc2hpcC5zZXRUZXh0dXJlKCJzaGllbGRlZCIgKyB0aGlzLnBsYXllcnNbZGF0YS5sb2NhbElkXS5jb2xvcik7CiAgICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogIm9uQ3VycmVudFNoaXBDb2xsaXNpb24iLAogICAgdmFsdWU6IGZ1bmN0aW9uIG9uQ3VycmVudFNoaXBDb2xsaXNpb24oY29sbGlzaW9uKSB7CiAgICAgIHZhciBwbGF5ZXIgPSB0aGlzLnBsYXllcnNbdGhpcy5jdXJyZW50UGxheWVyXTsKICAgICAgdmFyIGJvZHkgPSBnZXRCb2R5RnJvbUNvbGxpc2lvbihwbGF5ZXIuc2hpcC5ib2R5LmlkLCBjb2xsaXNpb24pOwoKICAgICAgaWYgKGJvZHkucGFyZW50LmNvbGxpc2lvbkZpbHRlci5jYXRlZ29yeSA9PT0gdGhpcy5idWxsZXRzQ2F0ZWdvcnkpIHsKICAgICAgICAvL2NvbGxpc2lvbiB3aXRoIGEgYnVsbGV0CiAgICAgICAgdGhpcy5vbkJ1bGxldENvbGxpc2lvbihwbGF5ZXIuc2hpcCwgYm9keS5nYW1lT2JqZWN0KTsKICAgICAgfSBlbHNlIGlmIChib2R5LnBhcmVudC5jb2xsaXNpb25GaWx0ZXIuY2F0ZWdvcnkgPT09IHRoaXMucG93ZXJVcHNDYXRlZ29yeSkgewogICAgICAgIC8vQ29sbGlzaW9uIHdpdGggcG93ZXIgdXAKICAgICAgICB0aGlzLm9uUG93ZXJVcENvbGxpc2lvbihwbGF5ZXIuc2hpcCwgYm9keS5nYW1lT2JqZWN0KTsKICAgICAgfSBlbHNlIGlmIChib2R5LnBhcmVudC5jb2xsaXNpb25GaWx0ZXIuY2F0ZWdvcnkgPT09IHRoaXMuc2hpcHNDYXRlZ29yeSkgewogICAgICAgIC8vQ29sbGlzaW9uIHdpdGggc2hpcAogICAgICAgIGlmICh0aGlzLnBsYXllcnNbdGhpcy5jdXJyZW50UGxheWVyXS5zdGF0ZSA9PT0gMSAmJiB0aGlzLnBsYXllcnNbYm9keS5nYW1lT2JqZWN0LmxvY2FsSWRdLnN0YXRlID49IDIpIHsKICAgICAgICAgIHZhciBkYXRhID0gewogICAgICAgICAgICBsb2NhbElkOiB0aGlzLmN1cnJlbnRQbGF5ZXIsCiAgICAgICAgICAgIHN0YXRlOiAwLAogICAgICAgICAgICBraWxsZWRCeTogYm9keS5nYW1lT2JqZWN0LmxvY2FsSWQKICAgICAgICAgIH07CiAgICAgICAgICB0aGlzLnNvY2tldC5lbWl0KHdlYnNvY2tldEV2ZW50cy5DSEFOR0VfU1RBVEUsIGRhdGEpOwogICAgICAgICAgdGhpcy51cGRhdGVTdGF0ZShkYXRhKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICJvbkJ1bGxldENvbGxpc2lvbiIsCiAgICB2YWx1ZTogZnVuY3Rpb24gb25CdWxsZXRDb2xsaXNpb24oc2hpcCwgYnVsbGV0KSB7CiAgICAgIHZhciBzdGF0ZSA9IHRoaXMucGxheWVyc1tzaGlwLmxvY2FsSWRdLnN0YXRlIC0gMTsKICAgICAgdmFyIGRhdGEgPSB7CiAgICAgICAgbG9jYWxJZDogc2hpcC5sb2NhbElkLAogICAgICAgIHN0YXRlOiBzdGF0ZQogICAgICB9OwoKICAgICAgaWYgKHN0YXRlID09PSAwKSB7CiAgICAgICAgZGF0YS5raWxsZWRCeSA9IGJ1bGxldC5zaG90Qnk7CiAgICAgICAgdGhpcy5jbGVhckludGVydmFscyhmYWxzZSk7CiAgICAgIH0KCiAgICAgIHRoaXMuc29ja2V0LmVtaXQod2Vic29ja2V0RXZlbnRzLkNIQU5HRV9TVEFURSwgZGF0YSk7CiAgICAgIHRoaXMudXBkYXRlU3RhdGUoZGF0YSk7CiAgICB9CiAgfSwgewogICAga2V5OiAib25Qb3dlclVwQ29sbGlzaW9uIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBvblBvd2VyVXBDb2xsaXNpb24oc2hpcCwgcG93ZXJVcCkgewogICAgICBpZiAodGhpcy5wbGF5ZXJzW3NoaXAubG9jYWxJZF0uc3RhdGUgPCAyKSByZXR1cm47CiAgICAgIHZhciBkYXRhID0gewogICAgICAgIHR5cGU6ICJnZXQiLAogICAgICAgIGxvY2FsSWQ6IHNoaXAubG9jYWxJZCwKICAgICAgICBwb3dlclVwOiBwb3dlclVwLnBvd2VyVXAsCiAgICAgICAgaWQ6IHBvd2VyVXAuaWQKICAgICAgfTsKICAgICAgdGhpcy5zb2NrZXQuZW1pdCh3ZWJzb2NrZXRFdmVudHMuUE9XRVJfVVAsIGRhdGEpOwogICAgICB0aGlzLnBvd2VyVXBFdmVudChkYXRhKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJyZWxvYWQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlbG9hZChkYXRhKSB7CiAgICAgIHRoaXMucGxheWVyc1tkYXRhLmxvY2FsSWRdLmF2YWlsYWJsZUJ1bGxldHMgPSBkYXRhLmF2YWlsYWJsZUJ1bGxldHM7CiAgICAgIHRoaXMucGxheWVyc1tkYXRhLmxvY2FsSWRdLmJ1bGxldHNMb2FkZWQuZW5hYmxlVG8oZGF0YS5hdmFpbGFibGVCdWxsZXRzKTsKICAgIH0gLy89PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgLy9HYW1lIGxvb3AgZnVuY3Rpb25zCgogIH0sIHsKICAgIGtleTogInNldEN1cnJlbnRQbGF5ZXJOZXdWZWxvY2l0eSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2V0Q3VycmVudFBsYXllck5ld1ZlbG9jaXR5KCkgewogICAgICB2YXIgX3ZlbG9jaXR5RnJvbUFuZ2xlMyA9IHZlbG9jaXR5RnJvbUFuZ2xlKHRoaXMucGxheWVyc1t0aGlzLmN1cnJlbnRQbGF5ZXJdLnNoaXAuYW5nbGUsIHRoaXMucGxheWVyc1t0aGlzLmN1cnJlbnRQbGF5ZXJdLnNoaXAudmVsb2NpdHlNYWduaXR1ZGUpLAogICAgICAgICAgeCA9IF92ZWxvY2l0eUZyb21BbmdsZTMueCwKICAgICAgICAgIHkgPSBfdmVsb2NpdHlGcm9tQW5nbGUzLnk7CgogICAgICB0aGlzLnBsYXllcnNbdGhpcy5jdXJyZW50UGxheWVyXS5zaGlwLnNldFZlbG9jaXR5KHgsIHkpOwogICAgfQogIH0sIHsKICAgIGtleTogImRlY2VsZXJhdGVMaXR0bGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGRlY2VsZXJhdGVMaXR0bGUoZGVsdGEpIHsKICAgICAgdGhpcy5wbGF5ZXJzW3RoaXMuY3VycmVudFBsYXllcl0uc2hpcC52ZWxvY2l0eU1hZ25pdHVkZSA9IE1hdGgubWF4KDAsIHRoaXMucGxheWVyc1t0aGlzLmN1cnJlbnRQbGF5ZXJdLnNoaXAudmVsb2NpdHlNYWduaXR1ZGUgLSB0aGlzLnNldHRpbmdzLmZyaWN0aW9uQWlyICogZGVsdGEpOwogICAgfQogIH0sIHsKICAgIGtleTogImdldExvYWRlZEJ1bGxldFBvc2l0aW9uIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRMb2FkZWRCdWxsZXRQb3NpdGlvbihpbmRleCwgdG9wTGVmdCwgYm90dG9tTGVmdCwgY2VudGVyTGVmdCwgcGxheWVyKSB7CiAgICAgIHN3aXRjaCAoaW5kZXgpIHsKICAgICAgICBjYXNlIDA6CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICB4OiBib3R0b21MZWZ0LnggLSBwbGF5ZXIuc2hpcC53aWR0aCAvIDQgKiBNYXRoLmNvcyhwbGF5ZXIuc2hpcC5yb3RhdGlvbiksCiAgICAgICAgICAgIHk6IGJvdHRvbUxlZnQueSAtIHBsYXllci5zaGlwLmhlaWdodCAvIDQgKiBNYXRoLnNpbihwbGF5ZXIuc2hpcC5yb3RhdGlvbikKICAgICAgICAgIH07CgogICAgICAgIGNhc2UgMToKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHg6IHRvcExlZnQueCAtIHBsYXllci5zaGlwLndpZHRoIC8gNCAqIE1hdGguY29zKHBsYXllci5zaGlwLnJvdGF0aW9uKSwKICAgICAgICAgICAgeTogdG9wTGVmdC55IC0gcGxheWVyLnNoaXAuaGVpZ2h0IC8gNCAqIE1hdGguc2luKHBsYXllci5zaGlwLnJvdGF0aW9uKQogICAgICAgICAgfTsKCiAgICAgICAgY2FzZSAyOgogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgeDogY2VudGVyTGVmdC54IC0gcGxheWVyLnNoaXAud2lkdGggLyA0ICogTWF0aC5jb3MocGxheWVyLnNoaXAucm90YXRpb24pLAogICAgICAgICAgICB5OiBjZW50ZXJMZWZ0LnkgLSBwbGF5ZXIuc2hpcC5oZWlnaHQgLyA0ICogTWF0aC5zaW4ocGxheWVyLnNoaXAucm90YXRpb24pCiAgICAgICAgICB9OwogICAgICB9CiAgICB9IC8vPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAgIC8vT24gY3JlYXRlIHNldHVwCgogIH0sIHsKICAgIGtleTogInNldFVwZGF0ZVNoaXBJbnRlcnZhbCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2V0VXBkYXRlU2hpcEludGVydmFsKCkgewogICAgICB2YXIgX3RoaXM3ID0gdGhpczsKCiAgICAgIGlmICh0aGlzLmN1cnJlbnRQbGF5ZXIgPT09IG51bGwpIHJldHVybjsKICAgICAgdmFyIGN1cnJlbnRQbGF5ZXIgPSB0aGlzLnBsYXllcnNbdGhpcy5jdXJyZW50UGxheWVyXTsKICAgICAgdGhpcy51cGRhdGVTaGlwSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbChmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKCFjdXJyZW50UGxheWVyLnNoaXAuYm9keSkgcmV0dXJuOwoKICAgICAgICBfdGhpczcuc29ja2V0LmVtaXQod2Vic29ja2V0RXZlbnRzLlVQREFURV9TSElQLCBbX3RoaXM3LmN1cnJlbnRQbGF5ZXIsIE1hdGguZmxvb3IoY3VycmVudFBsYXllci5zaGlwLmFuZ2xlKSwgW051bWJlci5wYXJzZUZsb2F0KGN1cnJlbnRQbGF5ZXIuc2hpcC54LnRvRml4ZWQoMikpLCBOdW1iZXIucGFyc2VGbG9hdChjdXJyZW50UGxheWVyLnNoaXAueS50b0ZpeGVkKDIpKV0sIF90aGlzNy50aW1lLm5vd10pOwogICAgICB9LCAxMDAwIC8gdGhpcy51cGRhdGVGcHMpOwogICAgfQogIH0sIHsKICAgIGtleTogInNldFJlbG9hZEludGVydmFsIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRSZWxvYWRJbnRlcnZhbCgpIHsKICAgICAgdmFyIF90aGlzOCA9IHRoaXM7CgogICAgICBpZiAodGhpcy5jdXJyZW50UGxheWVyID09PSBudWxsKSByZXR1cm47CiAgICAgIHRoaXMucmVsb2FkSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbChmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKF90aGlzOC5wbGF5ZXJzW190aGlzOC5jdXJyZW50UGxheWVyXS5zdGF0ZSA8IDIpIHJldHVybjsKICAgICAgICB2YXIgYXZhaWxhYmxlQnVsbGV0cyA9IE1hdGgubWluKF90aGlzOC5tYXhCdWxsZXRzLCBfdGhpczgucGxheWVyc1tfdGhpczguY3VycmVudFBsYXllcl0uYXZhaWxhYmxlQnVsbGV0cyArIDEpOwogICAgICAgIHZhciBkYXRhID0gewogICAgICAgICAgbG9jYWxJZDogX3RoaXM4LmN1cnJlbnRQbGF5ZXIsCiAgICAgICAgICBhdmFpbGFibGVCdWxsZXRzOiBhdmFpbGFibGVCdWxsZXRzCiAgICAgICAgfTsKCiAgICAgICAgX3RoaXM4LnNvY2tldC5lbWl0KHdlYnNvY2tldEV2ZW50cy5SRUxPQUQsIGRhdGEpOwoKICAgICAgICBfdGhpczgucmVsb2FkKGRhdGEpOwogICAgICB9LCAxIC8gKHRoaXMuc2V0dGluZ3MucmVsb2FkaW5nVmVsb2NpdHkgKiBhcmNhZGVOb3JtYWxpemVycy5yZWxvYWRpbmdWZWxvY2l0eSkpOwogICAgfQogIH0sIHsKICAgIGtleTogInNldFBvd2VyVXBJbnRlcnZhbCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2V0UG93ZXJVcEludGVydmFsKCkgewogICAgICB2YXIgX3RoaXM5ID0gdGhpczsKCiAgICAgIHRoaXMucG93ZXJVcEludGVydmFsID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkgewogICAgICAgIF90aGlzOS5nZW5lcmF0ZVBvd2VyVXAoe30sIDIpOwogICAgICB9LCB0aGlzLnBvd2VyVXBHZW5lcmF0aW9uVGltZSk7CiAgICB9CiAgfSwgewogICAga2V5OiAic2V0T25EZXN0cm95IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRPbkRlc3Ryb3koKSB7CiAgICAgIHZhciBfdGhpczEwID0gdGhpczsKCiAgICAgIGlmICh0aGlzLmN1cnJlbnRQbGF5ZXIgPT09IG51bGwpIHJldHVybjsKICAgICAgdGhpcy5ldmVudHMub24oImRlc3Ryb3kiLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgX3RoaXMxMC5jbGVhckludGVydmFscyh0cnVlKTsKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAiY2xlYXJJbnRlcnZhbHMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGNsZWFySW50ZXJ2YWxzKHBvd2VyVXApIHsKICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLnVwZGF0ZVNoaXBJbnRlcnZhbCk7CiAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5yZWxvYWRJbnRlcnZhbCk7CiAgICAgIGlmIChwb3dlclVwICYmIHRoaXMuY3VycmVudFBsYXllciA9PT0gdGhpcy5hZG1pbikgY2xlYXJJbnRlcnZhbCh0aGlzLnBvd2VyVXBJbnRlcnZhbCk7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gR2FtZVNjZW5lOwp9KFBoYXNlci5TY2VuZSk7CgpleHBvcnQgeyBHYW1lU2NlbmUgYXMgZGVmYXVsdCB9Ow=="},{"version":3,"sources":["/media/jacopo/VolumeDati/Documenti/papero.tk/cosmos.papero.me/src/phaser/GameScene.js"],"names":["Phaser","websocketEvents","gameDimensions","arcadeNormalizers","powerUps","sceneKeys","matterNormalizers","detectTouchScreen","removeFromArray","_","createMap","createBulletsLoadedObject","getBodyFromCollision","loadImages","setInputHandlers","velocityFromAngle","GameScene","socket","game","key","physics","default","matter","debug","setBounds","updateFps","touchScreen","defaultImageOptions","friction","frictionAir","frictionStatic","ignoreGravity","maxBullets","powerUpIds","powerUpGenerationTime","setUpGame","on","UPDATE_SHIP","data","updateShip","SHOOT","createBullet","CHANGE_STATE","updateState","RELOAD","reload","POWER_UP","powerUpEvent","END_TURN","setTimeout","clearIntervals","scene","start","ranking","cloneDeep","timer","settings","currentPlayer","admin","map","maxVelocityLittle","velocity","accelerationLittle","respawnTime","powerUpVelocity","powerUpAngularVelocity","players","forEach","player","localId","availableBullets","lastTimestamp","powerUpsObjects","console","log","Object","entries","length","Date","now","stop","values","Physics","Matter","Image","prototype","shapedSetOnCollide","callback","body","parts","part","onCollideCallback","setOnCollide","jsonShapes","cache","json","get","createCategories","createShips","setReloadInterval","setUpdateShipInterval","setPowerUpInterval","generatePowerUp","x","width","y","height","setOnDestroy","time","delta","ship","rotationKey","isDown","rotating","rotate","accelerateLittleKey","accelerating","moveLittle","setCurrentPlayerNewVelocity","state","decelerateLittle","topLeft","getTopLeft","bottomLeft","getBottomLeft","centerLeft","bulletsLoaded","gameObjects","bullet","index","getLoadedBulletPosition","autonomyTime","setVelocity","setAngularVelocity","shipsCategory","bulletsCategory","powerUpsCategory","mapObjectCategory","order","textures","add","image","color","shape","setCollisionCategory","setAngle","velocityMagnitude","setInertia","Infinity","collision","onCurrentShipCollision","angle","bulletVelocity","position","setCollidesWith","destroy","shotBy","killFirstAlive","newPowerUp","powerUp","id","push","maxLength","Math","Distance","Between","laser","setScale","setSensor","setPosition","cos","PI","sin","parent","collisionFilter","category","dataToSend","gameObject","killedBy","emit","killable","setMass","setToSleep","setAwake","n","i","type","floor","random","FloatBetween","deltaMilliseconds","deltaUnits","deltaTheta","sign","angularVelocity","createPowerUp","child","hasLaser","createLaser","previousMag","killAll","setTexture","enableAll","onBulletCollision","onPowerUpCollision","enableTo","max","rotation","updateShipInterval","setInterval","Number","parseFloat","toFixed","reloadInterval","min","reloadingVelocity","powerUpInterval","events","clearInterval","Scene"],"mappings":"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","sourcesContent":["import * as Phaser from \"phaser\";\nimport websocketEvents from \"../constants/websocketEvents\";\nimport {gameDimensions, arcadeNormalizers, powerUps, sceneKeys, matterNormalizers} from \"../constants/gameSettings\";\nimport {detectTouchScreen, removeFromArray} from \"../constants/constants\";\nimport _ from \"lodash\";\nimport createMap from \"../phaser/maps\";\n\nimport {\n    createBulletsLoadedObject,\n    getBodyFromCollision,\n    loadImages,\n    setInputHandlers,\n    velocityFromAngle\n} from \"./scene\";\n\n\nexport default class GameScene extends Phaser.Scene {\n\n    setUpGame(game){\n        this.timer = game.timer;\n        this.settings = game.settings;\n        this.currentPlayer = game.currentPlayer;\n        this.admin = game.admin;\n        this.map = game.map;\n        this.settings.maxVelocityLittle = game.settings.velocity+0.2;\n        this.settings.accelerationLittle = 0.4;\n        this.settings.respawnTime = 8000;\n        this.settings.frictionAir = 0.1;\n        this.settings.powerUpVelocity = 3;\n        this.settings.powerUpAngularVelocity = 0.1;\n        this.players = {};\n        game.players.forEach(player => {\n            this.players[player.localId] = _.cloneDeep(player);\n            this.players[player.localId].availableBullets = this.maxBullets;\n            this.players[player.localId].lastTimestamp = 0;\n        });\n        this.powerUpsObjects = [];\n    }\n\n    constructor(socket, game) {\n        super({\n            key: sceneKeys.game,\n            physics: {\n                default: \"matter\",\n                matter: {\n                    debug: false,\n                    setBounds: true\n                }\n            }\n        });\n\n        this.socket = socket;\n\n        this.updateFps = 10;\n        this.touchScreen = detectTouchScreen();\n        this.defaultImageOptions = {friction: 0, frictionAir: 0, frictionStatic: 0, ignoreGravity: true};\n        this.maxBullets = 3;\n        this.powerUpIds = 0;\n        this.powerUpGenerationTime = 10000;\n\n        this.setUpGame(game);\n\n        this.socket.on(websocketEvents.UPDATE_SHIP, data => this.updateShip(data));\n        this.socket.on(websocketEvents.SHOOT, data => this.createBullet(data));\n        this.socket.on(websocketEvents.CHANGE_STATE, data => this.updateState(data));\n        this.socket.on(websocketEvents.RELOAD, data => this.reload(data));\n        this.socket.on(websocketEvents.POWER_UP, data => this.powerUpEvent(data));\n        this.socket.on(websocketEvents.END_TURN, data => {\n            setTimeout(()=>{\n                this.clearIntervals(true);\n                this.scene.start(sceneKeys.ranking, _.cloneDeep(data));\n            }, 2000);\n        });\n    }\n\n    init(game){\n        console.log(\"Game scene init\", _.cloneDeep(game));\n        if(Object.entries(game).length>0) this.setUpGame(game);\n    }\n\n    preload(){\n        console.log(\"Game scene preload\")\n        loadImages(this, sceneKeys.game);\n    }\n\n    create(){\n        console.log(\"Game scene create\")\n        if(this.timer > Date.now()){\n            this.scene.stop();\n            this.scene.start(sceneKeys.ranking, _.cloneDeep({\n                players: _.cloneDeep(Object.values(this.players)),\n                timer: this.timer\n            }));\n        }\n        console.log(\"continuing create\");\n        Phaser.Physics.Matter.Image.prototype.shapedSetOnCollide = function (callback) {\n            if (this.body && this.body.parts && this.body.parts.length) {\n                for (let part of this.body.parts) {\n                    part.onCollideCallback = callback;\n                }\n            }\n            return this.setOnCollide(callback);\n        }\n\n        this.jsonShapes = this.cache.json.get(\"shapes\");\n\n        this.createCategories();\n        this.createShips();\n        createMap(this);\n\n        setInputHandlers(this, sceneKeys.game);\n\n        this.setReloadInterval();\n        this.setUpdateShipInterval();\n        if(this.admin === this.currentPlayer){\n            this.setPowerUpInterval();\n            this.generatePowerUp({x: gameDimensions.width/2, y: gameDimensions.height/2}, 2);\n        }\n\n        this.setOnDestroy();\n    }\n\n    update(time, delta){\n        if(this.currentPlayer !== null && this.players[this.currentPlayer].ship.body) {\n            if (this.rotationKey.isDown || this.rotating) this.rotate(delta);\n            if (this.accelerateLittleKey.isDown || this.accelerating) this.moveLittle(delta);\n\n            this.setCurrentPlayerNewVelocity();\n            if (this.players[this.currentPlayer].state === 1) this.decelerateLittle(delta);\n        }\n\n        Object.values(this.players).forEach(player => {\n            if(!player.ship.body) return;\n            const topLeft = player.ship.getTopLeft();\n            const bottomLeft = player.ship.getBottomLeft();\n            const centerLeft = {\n                x: (topLeft.x + bottomLeft.x) / 2,\n                y: (topLeft.y + bottomLeft.y) / 2\n            }\n            player.bulletsLoaded.gameObjects.forEach((bullet, index)=>{\n                const {x, y} = this.getLoadedBulletPosition(index, topLeft, bottomLeft, centerLeft, player);\n                bullet.x = x;\n                bullet.y = y;\n            });\n            if(player.localId!==this.currentPlayer){\n                player.ship.autonomyTime -= delta;\n                if(player.ship.autonomyTime<0) {\n                    player.ship.setVelocity(0);\n                    player.ship.setAngularVelocity(0);\n                }\n            }\n        });\n    }\n\n\n\n\n    //=============================================================================\n    //Creating things\n    createCategories(){\n        this.shipsCategory = 2;\n        this.bulletsCategory = 4;\n        this.powerUpsCategory = 8;\n        this.mapObjectCategory = 16;\n    }\n\n    createShips(){\n        const order = [0, 3, 2, 1];\n        let index = 0;\n        const textures = [\"\", \"little\", \"ship\", \"shielded\"];\n        Object.values(this.players).forEach(player => {\n            if(player.state === 0) return;\n\n            player.ship = this.matter.add.image(\n                (order[index]<2 ? 30 : gameDimensions.width-30),\n                ( order[index]%2 === 0 ? 30 : gameDimensions.height-30 ),\n                textures[player.state]+player.color,\n                null,\n                {\n                    ...this.defaultImageOptions,\n                    shape: this.jsonShapes.ship\n                }\n            );\n            player.ship.setCollisionCategory(this.shipsCategory);\n            player.ship.setAngle(-45  * ( order[index] < 2 ? 1 : 3) * ( ( order[index] % 2 ) * 2 - 1 ));\n            player.ship.velocityMagnitude = this.settings.velocity*matterNormalizers.velocity;\n            player.ship.localId = player.localId;\n            player.ship.autonomyTime = 0;\n            this.matter.body.setInertia(player.ship.body, Infinity);\n\n            player.bulletsLoaded = createBulletsLoadedObject(this);\n\n            if(player.localId===this.currentPlayer){\n                player.ship.shapedSetOnCollide((collision) => {\n                   this.onCurrentShipCollision(collision);\n                });\n            }\n            index++;\n        });\n    }\n\n    createBullet(data){\n        const {x, y} = velocityFromAngle(data.angle, this.settings.bulletVelocity*matterNormalizers.bulletVelocity);\n        const bullet = this.matter.add.image(\n            data.position.x,\n            data.position.y,\n            \"bullet\",\n            null,\n            this.defaultImageOptions\n        );\n        bullet.setCollisionCategory(this.bulletsCategory);\n        bullet.setCollidesWith([1, this.shipsCategory, this.mapObjectCategory]);\n        bullet.setOnCollide(()=>{\n            bullet.destroy();\n        });\n        bullet.setAngle(data.angle);\n        bullet.setVelocity(x, y);\n        bullet.shotBy = data.localId;\n        this.players[data.localId].availableBullets--;\n        this.players[data.localId].bulletsLoaded.killFirstAlive();\n        this.matter.body.setInertia(bullet.body, Infinity);\n    }\n\n    createPowerUp(data){\n        const newPowerUp = this.matter.add.image(data.position.x, data.position.y, data.powerUp, null,\n            {\n                ...this.defaultImageOptions,\n                shape: this.jsonShapes[data.powerUp]\n            });\n        const {x, y} = velocityFromAngle(data.angle, this.settings.powerUpVelocity);\n        newPowerUp.setVelocity(x, y);\n        newPowerUp.setAngularVelocity(this.settings.powerUpAngularVelocity);\n        newPowerUp.powerUp = data.powerUp;\n        newPowerUp.setCollisionCategory(this.powerUpsCategory);\n        newPowerUp.setCollidesWith([1, this.shipsCategory, this.mapObjectCategory]);\n        newPowerUp.id = data.id;\n        this.matter.body.setInertia(newPowerUp.body, Infinity);\n        this.powerUpsObjects.push(newPowerUp);\n    }\n\n    createLaser(data){\n        const maxLength = Phaser.Math.Distance.Between(0, 0, gameDimensions.width, gameDimensions.height);\n        const laser = this.matter.add.image(data.position.x, data.position.y, \"bullet\", null, this.defaultImageOptions);\n        laser.setScale(maxLength/laser.width, 1);\n        laser.setSensor(true);\n        laser.setAngle(data.angle);\n        laser.setPosition(laser.x+maxLength/2*Math.cos(data.angle*Math.PI/180), laser.y+maxLength/2*Math.sin(data.angle*Math.PI/180));\n        laser.setCollidesWith([this.shipsCategory, this.mapObjectCategory]);\n        laser.setOnCollide(collision => {\n            const body = getBodyFromCollision(laser.body.id, collision);\n            if(body.parent.collisionFilter.category === this.shipsCategory){\n                const dataToSend = {\n                    localId: body.parent.gameObject.localId,\n                    state: 0,\n                    killedBy: data.localId\n                };\n                this.clearIntervals(false);\n                this.socket.emit(websocketEvents.CHANGE_STATE, dataToSend);\n                this.updateState(dataToSend);\n            } else if(body.collisionFilter.category === this.mapObjectCategory){\n                if(body.gameObject.killable) body.gameObject.destroy();\n            }\n        });\n        this.matter.body.setMass(laser.body, Infinity);\n        this.players[data.localId].ship.setToSleep();\n        setTimeout(()=>{\n            laser.destroy();\n            this.players[data.localId].ship.setAwake();\n        }, 500);\n    }\n\n    generatePowerUp({x, y}, n=1){\n        for(let i = 0; i < n; i++){\n            const data = {\n                type: \"create\",\n                powerUp: powerUps[Math.floor(Math.random()*powerUps.length)],\n                position: {\n                    x: x || Phaser.Math.FloatBetween(0, gameDimensions.width),\n                    y: y || Phaser.Math.FloatBetween(0, gameDimensions.height)\n                },\n                angle: Phaser.Math.FloatBetween(0, 360),\n                id: ++this.powerUpIds\n            }\n            this.socket.emit(websocketEvents.POWER_UP, data);\n            this.powerUpEvent(data);\n        }\n    }\n\n\n\n\n    //=============================================================================\n    //Others do things via the websocket\n    updateShip(data){\n        const player = this.players[data[0]];\n        if(!player.ship) return;\n        const deltaMilliseconds = (data[3]-player.lastTimestamp);\n        const deltaUnits = deltaMilliseconds*60/1000;\n        if(deltaMilliseconds<=0) return;\n\n        let deltaTheta = data[1] - Math.floor(player.ship.angle);\n\n        if(deltaTheta*Math.sign(this.settings.angularVelocity) < -10) deltaTheta += 360*Math.sign(this.settings.angularVelocity);\n        else if(deltaTheta*Math.sign(this.settings.angularVelocity) < 0) deltaTheta = 0;\n        const angularVelocity = deltaTheta / deltaUnits;\n        player.ship.setAngularVelocity(angularVelocity * Math.PI / 180);\n        player.ship.setVelocity( ( data[2][0]-player.ship.x ) / deltaUnits, ( data[2][1]-player.ship.y ) / deltaUnits );\n\n        player.lastTimestamp = data[3];\n        player.ship.autonomyTime = deltaMilliseconds;\n    }\n\n    powerUpEvent(data){\n        //Create power up item\n        if(data.type === \"create\") this.createPowerUp(data);\n        //Player gets power up\n        else if(data.type === \"get\") {\n            for(let i=0; i<this.powerUpsObjects.length; i++){\n                const child = this.powerUpsObjects[i];\n                if(child.id === data.id){\n                    this.powerUpsObjects = removeFromArray(this.powerUpsObjects, i);\n                    child.destroy();\n                    break;\n                }\n            }\n            let dataToSend;\n            switch (data.powerUp){\n                case \"reverse\":\n                    this.settings.angularVelocity *= -1;\n                    break;\n                case \"shield\":\n                    dataToSend = {\n                        localId: data.localId,\n                        state: 3\n                    }\n                    this.socket.emit(websocketEvents.CHANGE_STATE, dataToSend);\n                    this.updateState(dataToSend);\n                    break;\n                case \"reload\":\n                    dataToSend = {\n                        localId: data.localId,\n                        availableBullets: this.maxBullets\n                    };\n                    this.socket.emit(websocketEvents.RELOAD, dataToSend);\n                    this.reload(dataToSend);\n                    break;\n                case \"laser\":\n                    this.players[data.localId].ship.hasLaser = true;\n            }\n        }\n        //Player uses power up\n        else if(data.type === \"use\") {\n            if (data.powerUp === \"laser\") this.createLaser(data);\n        }\n    }\n\n\n\n    //=============================================================================\n    //Current players does things\n    rotate(delta){\n        this.players[this.currentPlayer].ship.setAngle(\n            this.players[this.currentPlayer].ship.angle + delta * this.settings.angularVelocity * matterNormalizers.angularVelocity\n        );\n    }\n\n    moveLittle(delta){\n        const currentPlayer = this.players[this.currentPlayer];\n        if(currentPlayer.state === 1){\n            const ship = currentPlayer.ship;\n            const previousMag = ship.velocityMagnitude;\n            if(previousMag < this.settings.maxVelocityLittle * matterNormalizers.velocity){\n                currentPlayer.ship.velocityMagnitude += delta*this.settings.accelerationLittle;\n            } else {\n                currentPlayer.ship.velocityMagnitude = this.settings.maxVelocityLittle * matterNormalizers.velocity;\n            }\n        }\n    }\n\n    shoot(){\n        const currentPlayer = this.players[this.currentPlayer];\n        const ship = currentPlayer.ship;\n        const angle = ship.angle;\n        const data = {\n            position: {\n                x: ship.x + ship.width*5/4*Math.cos(angle * Math.PI / 180),\n                y: ship.y + ship.height*5/4*Math.sin(angle * Math.PI / 180)\n            },\n            angle: angle,\n            localId: this.currentPlayer\n        };\n        if(currentPlayer.ship.hasLaser){\n            data.type = \"use\";\n            data.powerUp = \"laser\";\n            this.socket.emit(websocketEvents.POWER_UP, data);\n            this.createLaser(data);\n            currentPlayer.ship.hasLaser = false;\n        } else {\n            if(currentPlayer.availableBullets>0){\n                this.socket.emit(websocketEvents.SHOOT, data);\n                this.createBullet(data);\n            }\n        }\n    }\n\n\n    updateState(data){\n        this.players[data.localId].state = data.state;\n        const player = this.players[data.localId];\n        switch (data.state) {\n            case 0:\n                player.ship.destroy();\n                this.players[data.localId].bulletsLoaded.killAll();\n                break;\n            case 1:\n                player.ship.setTexture(\"little\" + this.players[data.localId].color);\n                this.players[data.localId].bulletsLoaded.killAll();\n                if(data.localId === this.currentPlayer) {\n                    setTimeout(() => {\n                        if (this.players[data.localId].state === 1) {\n                            const data = {\n                                localId: this.currentPlayer,\n                                state: 2\n                            };\n                            this.updateState(data);\n                            this.socket.emit(websocketEvents.CHANGE_STATE, data);\n                        }\n                    }, this.settings.respawnTime);\n                }\n                break;\n            case 2:\n                player.ship.velocityMagnitude = this.settings.velocity * matterNormalizers.velocity;\n                player.ship.setTexture(\"ship\" + this.players[data.localId].color);\n                player.bulletsLoaded.enableAll();\n                break;\n            case 3:\n                player.ship.velocityMagnitude = this.settings.velocity * matterNormalizers.velocity;\n                player.ship.setTexture(\"shielded\" + this.players[data.localId].color);\n                break;\n        }\n    }\n\n    onCurrentShipCollision(collision) {\n        const player = this.players[this.currentPlayer];\n        const body = getBodyFromCollision(player.ship.body.id, collision);\n        if(body.parent.collisionFilter.category === this.bulletsCategory){\n            //collision with a bullet\n            this.onBulletCollision(player.ship, body.gameObject);\n        } else if(body.parent.collisionFilter.category === this.powerUpsCategory){\n            //Collision with power up\n            this.onPowerUpCollision(player.ship, body.gameObject);\n        } else if(body.parent.collisionFilter.category === this.shipsCategory){\n            //Collision with ship\n            if(this.players[this.currentPlayer].state === 1 && this.players[body.gameObject.localId].state >= 2){\n                const data = {\n                    localId: this.currentPlayer,\n                    state: 0,\n                    killedBy: body.gameObject.localId\n                };\n                this.socket.emit(websocketEvents.CHANGE_STATE, data);\n                this.updateState(data);\n            }\n        }\n    }\n\n    onBulletCollision(ship, bullet){\n        const state = this.players[ship.localId].state-1;\n        const data = {\n            localId: ship.localId,\n            state\n        };\n        if(state === 0) {\n            data.killedBy = bullet.shotBy;\n            this.clearIntervals(false);\n        }\n        this.socket.emit(websocketEvents.CHANGE_STATE, data);\n        this.updateState(data);\n    }\n\n    onPowerUpCollision(ship, powerUp){\n        if(this.players[ship.localId].state < 2 ) return;\n        const data = {\n            type: \"get\",\n            localId: ship.localId,\n            powerUp: powerUp.powerUp,\n            id: powerUp.id\n        }\n        this.socket.emit(websocketEvents.POWER_UP, data);\n        this.powerUpEvent(data);\n    }\n\n    reload(data){\n        this.players[data.localId].availableBullets = data.availableBullets;\n        this.players[data.localId].bulletsLoaded.enableTo(data.availableBullets);\n    }\n\n\n    //=============================================================================\n    //Game loop functions\n    setCurrentPlayerNewVelocity(){\n        const {x, y} = velocityFromAngle(\n            this.players[this.currentPlayer].ship.angle,\n            this.players[this.currentPlayer].ship.velocityMagnitude\n        );\n        this.players[this.currentPlayer].ship.setVelocity(x, y);\n    }\n\n    decelerateLittle(delta){\n        this.players[this.currentPlayer].ship.velocityMagnitude = Math.max(\n            0, this.players[this.currentPlayer].ship.velocityMagnitude - this.settings.frictionAir * delta\n        );\n    }\n\n    getLoadedBulletPosition(index, topLeft, bottomLeft, centerLeft, player){\n        switch (index){\n            case 0:\n                return {\n                    x: bottomLeft.x - (player.ship.width/4)*Math.cos(player.ship.rotation),\n                    y: bottomLeft.y - (player.ship.height/4)*Math.sin(player.ship.rotation)\n                };\n            case 1:\n                return{\n                    x: topLeft.x - (player.ship.width/4)*Math.cos(player.ship.rotation),\n                    y: topLeft.y - (player.ship.height/4)*Math.sin(player.ship.rotation)\n                };\n            case 2:\n                return {\n                    x: centerLeft.x - (player.ship.width/4)*Math.cos(player.ship.rotation),\n                    y: centerLeft.y - (player.ship.height/4)*Math.sin(player.ship.rotation)\n                };\n        }\n    }\n\n\n\n    //=============================================================================\n    //On create setup\n    setUpdateShipInterval(){\n        if(this.currentPlayer === null) return;\n\n        const currentPlayer = this.players[this.currentPlayer];\n        this.updateShipInterval = setInterval(()=>{\n            if(!currentPlayer.ship.body) return;\n            this.socket.emit(websocketEvents.UPDATE_SHIP, [\n                this.currentPlayer,\n                Math.floor(currentPlayer.ship.angle),\n                [\n                    Number.parseFloat(currentPlayer.ship.x.toFixed(2)),\n                    Number.parseFloat(currentPlayer.ship.y.toFixed(2))\n                ],\n                this.time.now\n            ]);\n        }, 1000/this.updateFps);\n    }\n\n    setReloadInterval(){\n        if(this.currentPlayer === null) return;\n\n        this.reloadInterval = setInterval(() => {\n            if(this.players[this.currentPlayer].state<2) return;\n            const availableBullets = Math.min(this.maxBullets, this.players[this.currentPlayer].availableBullets + 1);\n            const data = {\n                localId: this.currentPlayer,\n                availableBullets\n            };\n            this.socket.emit(websocketEvents.RELOAD, data);\n            this.reload(data);\n        }, 1/(this.settings.reloadingVelocity * arcadeNormalizers.reloadingVelocity));\n    }\n\n    setPowerUpInterval(){\n        this.powerUpInterval = setInterval(()=>{\n            this.generatePowerUp({}, 2);\n        }, this.powerUpGenerationTime);\n    }\n\n    setOnDestroy(){\n        if(this.currentPlayer === null) return;\n\n        this.events.on(\"destroy\", ()=>{\n            this.clearIntervals(true);\n        });\n    }\n\n    clearIntervals(powerUp){\n        clearInterval(this.updateShipInterval);\n        clearInterval(this.reloadInterval);\n        if(powerUp && this.currentPlayer===this.admin) clearInterval(this.powerUpInterval);\n    }\n}"]}]}