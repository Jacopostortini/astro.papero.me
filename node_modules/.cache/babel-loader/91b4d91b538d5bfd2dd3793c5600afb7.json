{"remainingRequest":"C:\\Users\\matte\\Desktop\\papero\\cosmos.papero.me\\node_modules\\thread-loader\\dist\\cjs.js!C:\\Users\\matte\\Desktop\\papero\\cosmos.papero.me\\node_modules\\babel-loader\\lib\\index.js!C:\\Users\\matte\\Desktop\\papero\\cosmos.papero.me\\node_modules\\eslint-loader\\index.js??ref--13-0!C:\\Users\\matte\\Desktop\\papero\\cosmos.papero.me\\src\\phaser\\GameScene.js","dependencies":[{"path":"C:\\Users\\matte\\Desktop\\papero\\cosmos.papero.me\\src\\phaser\\GameScene.js","mtime":1620287146838},{"path":"C:\\Users\\matte\\Desktop\\papero\\cosmos.papero.me\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1618302247254},{"path":"C:\\Users\\matte\\Desktop\\papero\\cosmos.papero.me\\node_modules\\thread-loader\\dist\\cjs.js","mtime":1618302273214},{"path":"C:\\Users\\matte\\Desktop\\papero\\cosmos.papero.me\\node_modules\\babel-loader\\lib\\index.js","mtime":1618302246598},{"path":"C:\\Users\\matte\\Desktop\\papero\\cosmos.papero.me\\node_modules\\eslint-loader\\index.js","mtime":1618302253346}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IF9vYmplY3RTcHJlYWQgZnJvbSAiQzovVXNlcnMvbWF0dGUvRGVza3RvcC9wYXBlcm8vY29zbW9zLnBhcGVyby5tZS9ub2RlX21vZHVsZXMvQGJhYmVsL3J1bnRpbWUvaGVscGVycy9lc20vb2JqZWN0U3ByZWFkMiI7CmltcG9ydCBfY3JlYXRlRm9yT2ZJdGVyYXRvckhlbHBlciBmcm9tICJDOi9Vc2Vycy9tYXR0ZS9EZXNrdG9wL3BhcGVyby9jb3Ntb3MucGFwZXJvLm1lL25vZGVfbW9kdWxlcy9AYmFiZWwvcnVudGltZS9oZWxwZXJzL2VzbS9jcmVhdGVGb3JPZkl0ZXJhdG9ySGVscGVyIjsKaW1wb3J0IF9jbGFzc0NhbGxDaGVjayBmcm9tICJDOi9Vc2Vycy9tYXR0ZS9EZXNrdG9wL3BhcGVyby9jb3Ntb3MucGFwZXJvLm1lL25vZGVfbW9kdWxlcy9AYmFiZWwvcnVudGltZS9oZWxwZXJzL2VzbS9jbGFzc0NhbGxDaGVjayI7CmltcG9ydCBfY3JlYXRlQ2xhc3MgZnJvbSAiQzovVXNlcnMvbWF0dGUvRGVza3RvcC9wYXBlcm8vY29zbW9zLnBhcGVyby5tZS9ub2RlX21vZHVsZXMvQGJhYmVsL3J1bnRpbWUvaGVscGVycy9lc20vY3JlYXRlQ2xhc3MiOwppbXBvcnQgX2luaGVyaXRzIGZyb20gIkM6L1VzZXJzL21hdHRlL0Rlc2t0b3AvcGFwZXJvL2Nvc21vcy5wYXBlcm8ubWUvbm9kZV9tb2R1bGVzL0BiYWJlbC9ydW50aW1lL2hlbHBlcnMvZXNtL2luaGVyaXRzIjsKaW1wb3J0IF9jcmVhdGVTdXBlciBmcm9tICJDOi9Vc2Vycy9tYXR0ZS9EZXNrdG9wL3BhcGVyby9jb3Ntb3MucGFwZXJvLm1lL25vZGVfbW9kdWxlcy9AYmFiZWwvcnVudGltZS9oZWxwZXJzL2VzbS9jcmVhdGVTdXBlciI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5Lm1hcC5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL3dlYi5kb20tY29sbGVjdGlvbnMuZm9yLWVhY2guanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5vYmplY3QuZW50cmllcy5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLm9iamVjdC52YWx1ZXMuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5tYXRoLnNpZ24uanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5udW1iZXIucGFyc2UtZmxvYXQuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5udW1iZXIuY29uc3RydWN0b3IuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5udW1iZXIudG8tZml4ZWQuanMiOwppbXBvcnQgKiBhcyBQaGFzZXIgZnJvbSAicGhhc2VyIjsKaW1wb3J0IHdlYnNvY2tldEV2ZW50cyBmcm9tICIuLi9jb25zdGFudHMvd2Vic29ja2V0RXZlbnRzIjsKaW1wb3J0IHsgZ2FtZURpbWVuc2lvbnMsIGFyY2FkZU5vcm1hbGl6ZXJzLCBwb3dlclVwcywgc2NlbmVLZXlzLCBtYXR0ZXJOb3JtYWxpemVycyB9IGZyb20gIi4uL2NvbnN0YW50cy9nYW1lU2V0dGluZ3MiOwppbXBvcnQgeyBkZXRlY3RUb3VjaFNjcmVlbiwgcmVtb3ZlRnJvbUFycmF5IH0gZnJvbSAiLi4vY29uc3RhbnRzL2NvbnN0YW50cyI7CmltcG9ydCBfIGZyb20gImxvZGFzaCI7CmltcG9ydCBjcmVhdGVNYXAgZnJvbSAiLi4vcGhhc2VyL21hcHMiOwppbXBvcnQgeyBjcmVhdGVCdWxsZXRzTG9hZGVkT2JqZWN0LCBnZXRCb2R5RnJvbUNvbGxpc2lvbiwgbG9hZEltYWdlcywgc2V0SW5wdXRIYW5kbGVycywgdmVsb2NpdHlGcm9tQW5nbGUgfSBmcm9tICIuL3NjZW5lIjsKCnZhciBHYW1lU2NlbmUgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKF9QaGFzZXIkU2NlbmUpIHsKICBfaW5oZXJpdHMoR2FtZVNjZW5lLCBfUGhhc2VyJFNjZW5lKTsKCiAgdmFyIF9zdXBlciA9IF9jcmVhdGVTdXBlcihHYW1lU2NlbmUpOwoKICBmdW5jdGlvbiBHYW1lU2NlbmUoc29ja2V0LCBnYW1lKSB7CiAgICB2YXIgX3RoaXM7CgogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIEdhbWVTY2VuZSk7CgogICAgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzLCB7CiAgICAgIGtleTogc2NlbmVLZXlzLmdhbWUsCiAgICAgIHBoeXNpY3M6IHsKICAgICAgICBkZWZhdWx0OiAibWF0dGVyIiwKICAgICAgICBtYXR0ZXI6IHsKICAgICAgICAgIGRlYnVnOiBmYWxzZSwKICAgICAgICAgIHNldEJvdW5kczogdHJ1ZQogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICBfdGhpcy5zb2NrZXQgPSBzb2NrZXQ7CiAgICBfdGhpcy51cGRhdGVGcHMgPSAxMDsKICAgIF90aGlzLnRvdWNoU2NyZWVuID0gZGV0ZWN0VG91Y2hTY3JlZW4oKTsKICAgIF90aGlzLmRlZmF1bHRJbWFnZU9wdGlvbnMgPSB7CiAgICAgIGZyaWN0aW9uOiAwLAogICAgICBmcmljdGlvbkFpcjogMCwKICAgICAgZnJpY3Rpb25TdGF0aWM6IDAsCiAgICAgIGlnbm9yZUdyYXZpdHk6IHRydWUKICAgIH07CiAgICBfdGhpcy5tYXhCdWxsZXRzID0gMzsKICAgIF90aGlzLnBvd2VyVXBJZHMgPSAwOwogICAgX3RoaXMucG93ZXJVcEdlbmVyYXRpb25UaW1lID0gMTAwMDA7CgogICAgX3RoaXMuc2V0VXBHYW1lKGdhbWUpOwoKICAgIF90aGlzLnNvY2tldC5vbih3ZWJzb2NrZXRFdmVudHMuVVBEQVRFX1NISVAsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgIHJldHVybiBfdGhpcy51cGRhdGVTaGlwKGRhdGEpOwogICAgfSk7CgogICAgX3RoaXMuc29ja2V0Lm9uKHdlYnNvY2tldEV2ZW50cy5TSE9PVCwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgcmV0dXJuIF90aGlzLmNyZWF0ZUJ1bGxldChkYXRhKTsKICAgIH0pOwoKICAgIF90aGlzLnNvY2tldC5vbih3ZWJzb2NrZXRFdmVudHMuQ0hBTkdFX1NUQVRFLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICByZXR1cm4gX3RoaXMudXBkYXRlU3RhdGUoZGF0YSk7CiAgICB9KTsKCiAgICBfdGhpcy5zb2NrZXQub24od2Vic29ja2V0RXZlbnRzLlJFTE9BRCwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgcmV0dXJuIF90aGlzLnJlbG9hZChkYXRhKTsKICAgIH0pOwoKICAgIF90aGlzLnNvY2tldC5vbih3ZWJzb2NrZXRFdmVudHMuUE9XRVJfVVAsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgIHJldHVybiBfdGhpcy5wb3dlclVwRXZlbnQoZGF0YSk7CiAgICB9KTsKCiAgICBfdGhpcy5zb2NrZXQub24od2Vic29ja2V0RXZlbnRzLkVORF9UVVJOLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICBfdGhpcy5jbGVhckludGVydmFscyh0cnVlKTsKCiAgICAgICAgX3RoaXMuc2NlbmUuc3RhcnQoc2NlbmVLZXlzLnJhbmtpbmcsIF8uY2xvbmVEZWVwKGRhdGEpKTsKICAgICAgfSwgMjAwMCk7CiAgICB9KTsKCiAgICBfdGhpcy5zZXRWaXNpYmlsaXR5Q2hhbmdlRXZlbnQoKTsKCiAgICByZXR1cm4gX3RoaXM7CiAgfQoKICBfY3JlYXRlQ2xhc3MoR2FtZVNjZW5lLCBbewogICAga2V5OiAic2V0VXBHYW1lIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRVcEdhbWUoZ2FtZSkgewogICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgIHRoaXMuc3RhdHVzID0gZ2FtZS5zdGF0dXM7CiAgICAgIHRoaXMudGltZXIgPSBnYW1lLnRpbWVyOwogICAgICB0aGlzLnNldHRpbmdzID0gZ2FtZS5zZXR0aW5nczsKICAgICAgdGhpcy5jdXJyZW50UGxheWVyID0gZ2FtZS5jdXJyZW50UGxheWVyOwogICAgICB0aGlzLmFkbWluID0gZ2FtZS5hZG1pbjsKICAgICAgdGhpcy5tYXAgPSBnYW1lLm1hcDsKICAgICAgdGhpcy5zZXR0aW5ncy5tYXhWZWxvY2l0eUxpdHRsZSA9IGdhbWUuc2V0dGluZ3MudmVsb2NpdHkgKyAwLjI7CiAgICAgIHRoaXMuc2V0dGluZ3MuYWNjZWxlcmF0aW9uTGl0dGxlID0gMC4xOwogICAgICB0aGlzLnNldHRpbmdzLnJlc3Bhd25UaW1lID0gODAwMDsKICAgICAgdGhpcy5zZXR0aW5ncy5mcmljdGlvbkFpciA9IDAuMDA1OwogICAgICB0aGlzLnNldHRpbmdzLnBvd2VyVXBWZWxvY2l0eSA9IDM7CiAgICAgIHRoaXMuc2V0dGluZ3MucG93ZXJVcEFuZ3VsYXJWZWxvY2l0eSA9IDAuMTsKICAgICAgdGhpcy5wbGF5ZXJzID0ge307CiAgICAgIGdhbWUucGxheWVycy5mb3JFYWNoKGZ1bmN0aW9uIChwbGF5ZXIpIHsKICAgICAgICBfdGhpczIucGxheWVyc1twbGF5ZXIubG9jYWxJZF0gPSBfLmNsb25lRGVlcChwbGF5ZXIpOwogICAgICAgIF90aGlzMi5wbGF5ZXJzW3BsYXllci5sb2NhbElkXS5hdmFpbGFibGVCdWxsZXRzID0gX3RoaXMyLm1heEJ1bGxldHM7CiAgICAgICAgX3RoaXMyLnBsYXllcnNbcGxheWVyLmxvY2FsSWRdLmxhc3RUaW1lc3RhbXAgPSAwOwogICAgICB9KTsKICAgICAgdGhpcy5wb3dlclVwc09iamVjdHMgPSBbXTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJpbml0IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBpbml0KGdhbWUpIHsKICAgICAgY29uc29sZS5sb2coIkdhbWUgc2NlbmUgaW5pdCIsIF8uY2xvbmVEZWVwKGdhbWUpKTsKICAgICAgaWYgKE9iamVjdC5lbnRyaWVzKGdhbWUpLmxlbmd0aCA+IDApIHRoaXMuc2V0VXBHYW1lKGdhbWUpOwogICAgfQogIH0sIHsKICAgIGtleTogInByZWxvYWQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHByZWxvYWQoKSB7CiAgICAgIGNvbnNvbGUubG9nKCJHYW1lIHNjZW5lIHByZWxvYWQiKTsKICAgICAgbG9hZEltYWdlcyh0aGlzLCBzY2VuZUtleXMuZ2FtZSk7CiAgICB9CiAgfSwgewogICAga2V5OiAiY3JlYXRlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBjcmVhdGUoKSB7CiAgICAgIHZhciBfdGhpczMgPSB0aGlzOwoKICAgICAgY29uc29sZS5sb2coIkdhbWUgc2NlbmUgY3JlYXRlIik7CgogICAgICBpZiAodGhpcy5zdGF0dXMgLSBNYXRoLmZsb29yKHRoaXMuc3RhdHVzKSA9PT0gMC41KSB7CiAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAoX3RoaXMzLnRpbWVyID4gRGF0ZS5ub3coKSkgewogICAgICAgICAgICBfdGhpczMuc2NlbmUuc3RvcCgpOwoKICAgICAgICAgICAgX3RoaXMzLnNjZW5lLnN0YXJ0KHNjZW5lS2V5cy5yYW5raW5nLCBfLmNsb25lRGVlcCh7CiAgICAgICAgICAgICAgcGxheWVyczogXy5jbG9uZURlZXAoT2JqZWN0LnZhbHVlcyhfdGhpczMucGxheWVycykpLAogICAgICAgICAgICAgIHRpbWVyOiBfdGhpczMudGltZXIKICAgICAgICAgICAgfSkpOwogICAgICAgICAgfQogICAgICAgIH0sIDEwMCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBjb25zb2xlLmxvZygiY29udGludWluZyBjcmVhdGUiKTsKCiAgICAgIFBoYXNlci5QaHlzaWNzLk1hdHRlci5JbWFnZS5wcm90b3R5cGUuc2hhcGVkU2V0T25Db2xsaWRlID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgaWYgKHRoaXMuYm9keSAmJiB0aGlzLmJvZHkucGFydHMgJiYgdGhpcy5ib2R5LnBhcnRzLmxlbmd0aCkgewogICAgICAgICAgdmFyIF9pdGVyYXRvciA9IF9jcmVhdGVGb3JPZkl0ZXJhdG9ySGVscGVyKHRoaXMuYm9keS5wYXJ0cyksCiAgICAgICAgICAgICAgX3N0ZXA7CgogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZm9yIChfaXRlcmF0b3IucygpOyAhKF9zdGVwID0gX2l0ZXJhdG9yLm4oKSkuZG9uZTspIHsKICAgICAgICAgICAgICB2YXIgcGFydCA9IF9zdGVwLnZhbHVlOwogICAgICAgICAgICAgIHBhcnQub25Db2xsaWRlQ2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIF9pdGVyYXRvci5lKGVycik7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBfaXRlcmF0b3IuZigpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXMuc2V0T25Db2xsaWRlKGNhbGxiYWNrKTsKICAgICAgfTsKCiAgICAgIHRoaXMuanNvblNoYXBlcyA9IHRoaXMuY2FjaGUuanNvbi5nZXQoInNoYXBlcyIpOwogICAgICB0aGlzLmNyZWF0ZUNhdGVnb3JpZXMoKTsKICAgICAgdGhpcy5jcmVhdGVTaGlwcygpOwogICAgICBjcmVhdGVNYXAodGhpcyk7CiAgICAgIHNldElucHV0SGFuZGxlcnModGhpcywgc2NlbmVLZXlzLmdhbWUpOwogICAgICB0aGlzLnNldFJlbG9hZEludGVydmFsKCk7CiAgICAgIHRoaXMuc2V0VXBkYXRlU2hpcEludGVydmFsKCk7CgogICAgICBpZiAodGhpcy5hZG1pbiA9PT0gdGhpcy5jdXJyZW50UGxheWVyKSB7CiAgICAgICAgdGhpcy5zZXRQb3dlclVwSW50ZXJ2YWwoKTsKICAgICAgICB0aGlzLmdlbmVyYXRlUG93ZXJVcCh7CiAgICAgICAgICB4OiBnYW1lRGltZW5zaW9ucy53aWR0aCAvIDIsCiAgICAgICAgICB5OiBnYW1lRGltZW5zaW9ucy5oZWlnaHQgLyAyCiAgICAgICAgfSwgMik7CiAgICAgIH0KCiAgICAgIHRoaXMuc2V0T25EZXN0cm95KCk7CiAgICB9CiAgfSwgewogICAga2V5OiAidXBkYXRlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB1cGRhdGUodGltZSwgZGVsdGEpIHsKICAgICAgdmFyIF90aGlzNCA9IHRoaXM7CgogICAgICBpZiAodGhpcy5jdXJyZW50UGxheWVyICE9PSBudWxsICYmIHRoaXMucGxheWVyc1t0aGlzLmN1cnJlbnRQbGF5ZXJdLnNoaXAgJiYgdGhpcy5wbGF5ZXJzW3RoaXMuY3VycmVudFBsYXllcl0uc2hpcC5ib2R5KSB7CiAgICAgICAgaWYgKHRoaXMucm90YXRpb25LZXkuaXNEb3duIHx8IHRoaXMucm90YXRpbmcpIHRoaXMucm90YXRlKGRlbHRhKTsKICAgICAgICBpZiAodGhpcy5hY2NlbGVyYXRlTGl0dGxlS2V5LmlzRG93biB8fCB0aGlzLmFjY2VsZXJhdGluZykgdGhpcy5tb3ZlTGl0dGxlKGRlbHRhKTsKICAgICAgICB0aGlzLnNldEN1cnJlbnRQbGF5ZXJOZXdWZWxvY2l0eSgpOwogICAgICAgIGlmICh0aGlzLnBsYXllcnNbdGhpcy5jdXJyZW50UGxheWVyXS5zdGF0ZSA9PT0gMSkgdGhpcy5kZWNlbGVyYXRlTGl0dGxlKGRlbHRhKTsKICAgICAgfQoKICAgICAgT2JqZWN0LnZhbHVlcyh0aGlzLnBsYXllcnMpLmZvckVhY2goZnVuY3Rpb24gKHBsYXllcikgewogICAgICAgIGlmICghcGxheWVyLnNoaXAgfHwgIXBsYXllci5zaGlwLmJvZHkpIHJldHVybjsKICAgICAgICB2YXIgdG9wTGVmdCA9IHBsYXllci5zaGlwLmdldFRvcExlZnQoKTsKICAgICAgICB2YXIgYm90dG9tTGVmdCA9IHBsYXllci5zaGlwLmdldEJvdHRvbUxlZnQoKTsKICAgICAgICB2YXIgY2VudGVyTGVmdCA9IHsKICAgICAgICAgIHg6ICh0b3BMZWZ0LnggKyBib3R0b21MZWZ0LngpIC8gMiwKICAgICAgICAgIHk6ICh0b3BMZWZ0LnkgKyBib3R0b21MZWZ0LnkpIC8gMgogICAgICAgIH07CiAgICAgICAgcGxheWVyLmJ1bGxldHNMb2FkZWQuZ2FtZU9iamVjdHMuZm9yRWFjaChmdW5jdGlvbiAoYnVsbGV0LCBpbmRleCkgewogICAgICAgICAgdmFyIF90aGlzNCRnZXRMb2FkZWRCdWxsZSA9IF90aGlzNC5nZXRMb2FkZWRCdWxsZXRQb3NpdGlvbihpbmRleCwgdG9wTGVmdCwgYm90dG9tTGVmdCwgY2VudGVyTGVmdCwgcGxheWVyKSwKICAgICAgICAgICAgICB4ID0gX3RoaXM0JGdldExvYWRlZEJ1bGxlLngsCiAgICAgICAgICAgICAgeSA9IF90aGlzNCRnZXRMb2FkZWRCdWxsZS55OwoKICAgICAgICAgIGJ1bGxldC54ID0geDsKICAgICAgICAgIGJ1bGxldC55ID0geTsKICAgICAgICB9KTsKCiAgICAgICAgaWYgKHBsYXllci5sb2NhbElkICE9PSBfdGhpczQuY3VycmVudFBsYXllcikgewogICAgICAgICAgcGxheWVyLnNoaXAuYXV0b25vbXlUaW1lIC09IGRlbHRhOwoKICAgICAgICAgIGlmIChwbGF5ZXIuc2hpcC5hdXRvbm9teVRpbWUgPCAwKSB7CiAgICAgICAgICAgIHBsYXllci5zaGlwLnNldFZlbG9jaXR5KDApOwogICAgICAgICAgICBwbGF5ZXIuc2hpcC5zZXRBbmd1bGFyVmVsb2NpdHkoMCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0gLy89PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgLy9DcmVhdGluZyB0aGluZ3MKCiAgfSwgewogICAga2V5OiAiY3JlYXRlQ2F0ZWdvcmllcyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlQ2F0ZWdvcmllcygpIHsKICAgICAgdGhpcy5zaGlwc0NhdGVnb3J5ID0gMjsKICAgICAgdGhpcy5idWxsZXRzQ2F0ZWdvcnkgPSA0OwogICAgICB0aGlzLnBvd2VyVXBzQ2F0ZWdvcnkgPSA4OwogICAgICB0aGlzLm1hcE9iamVjdENhdGVnb3J5ID0gMTY7CiAgICAgIHRoaXMubGFzZXJDYXRlZ29yeSA9IDMyOwogICAgfQogIH0sIHsKICAgIGtleTogImNyZWF0ZVNoaXBzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBjcmVhdGVTaGlwcygpIHsKICAgICAgdmFyIF90aGlzNSA9IHRoaXM7CgogICAgICB2YXIgb3JkZXIgPSBbMCwgMywgMiwgMV07CiAgICAgIHZhciBpbmRleCA9IDA7CiAgICAgIHZhciB0ZXh0dXJlcyA9IFsiIiwgImxpdHRsZSIsICJzaGlwIiwgInNoaWVsZGVkIl07CiAgICAgIE9iamVjdC52YWx1ZXModGhpcy5wbGF5ZXJzKS5mb3JFYWNoKGZ1bmN0aW9uIChwbGF5ZXIpIHsKICAgICAgICBpZiAocGxheWVyLnN0YXRlID09PSAwKSByZXR1cm47CiAgICAgICAgcGxheWVyLnNoaXAgPSBfdGhpczUubWF0dGVyLmFkZC5pbWFnZShvcmRlcltpbmRleF0gPCAyID8gMzAgOiBnYW1lRGltZW5zaW9ucy53aWR0aCAtIDMwLCBvcmRlcltpbmRleF0gJSAyID09PSAwID8gMzAgOiBnYW1lRGltZW5zaW9ucy5oZWlnaHQgLSAzMCwgdGV4dHVyZXNbcGxheWVyLnN0YXRlXSArIHBsYXllci5jb2xvciwgbnVsbCwgX29iamVjdFNwcmVhZChfb2JqZWN0U3ByZWFkKHt9LCBfdGhpczUuZGVmYXVsdEltYWdlT3B0aW9ucyksIHt9LCB7CiAgICAgICAgICBzaGFwZTogX3RoaXM1Lmpzb25TaGFwZXMuc2hpcAogICAgICAgIH0pKTsKICAgICAgICBwbGF5ZXIuc2hpcC5zZXRDb2xsaXNpb25DYXRlZ29yeShfdGhpczUuc2hpcHNDYXRlZ29yeSk7CiAgICAgICAgcGxheWVyLnNoaXAuc2V0QW5nbGUoLTQ1ICogKG9yZGVyW2luZGV4XSA8IDIgPyAxIDogMykgKiAob3JkZXJbaW5kZXhdICUgMiAqIDIgLSAxKSk7CiAgICAgICAgcGxheWVyLnNoaXAudmVsb2NpdHlNYWduaXR1ZGUgPSBfdGhpczUuc2V0dGluZ3MudmVsb2NpdHkgKiBtYXR0ZXJOb3JtYWxpemVycy52ZWxvY2l0eTsKICAgICAgICBwbGF5ZXIuc2hpcC5sb2NhbElkID0gcGxheWVyLmxvY2FsSWQ7CiAgICAgICAgcGxheWVyLnNoaXAuYXV0b25vbXlUaW1lID0gMDsKCiAgICAgICAgX3RoaXM1Lm1hdHRlci5ib2R5LnNldEluZXJ0aWEocGxheWVyLnNoaXAuYm9keSwgSW5maW5pdHkpOwoKICAgICAgICBwbGF5ZXIuYnVsbGV0c0xvYWRlZCA9IGNyZWF0ZUJ1bGxldHNMb2FkZWRPYmplY3QoX3RoaXM1KTsKCiAgICAgICAgaWYgKHBsYXllci5sb2NhbElkID09PSBfdGhpczUuY3VycmVudFBsYXllcikgewogICAgICAgICAgcGxheWVyLnNoaXAuc2hhcGVkU2V0T25Db2xsaWRlKGZ1bmN0aW9uIChjb2xsaXNpb24pIHsKICAgICAgICAgICAgX3RoaXM1Lm9uQ3VycmVudFNoaXBDb2xsaXNpb24oY29sbGlzaW9uKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgaW5kZXgrKzsKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAiY3JlYXRlQnVsbGV0IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBjcmVhdGVCdWxsZXQoZGF0YSkgewogICAgICB2YXIgX3ZlbG9jaXR5RnJvbUFuZ2xlID0gdmVsb2NpdHlGcm9tQW5nbGUoZGF0YS5hbmdsZSwgdGhpcy5zZXR0aW5ncy5idWxsZXRWZWxvY2l0eSAqIG1hdHRlck5vcm1hbGl6ZXJzLmJ1bGxldFZlbG9jaXR5KSwKICAgICAgICAgIHggPSBfdmVsb2NpdHlGcm9tQW5nbGUueCwKICAgICAgICAgIHkgPSBfdmVsb2NpdHlGcm9tQW5nbGUueTsKCiAgICAgIHZhciBidWxsZXQgPSB0aGlzLm1hdHRlci5hZGQuaW1hZ2UoZGF0YS5wb3NpdGlvbi54LCBkYXRhLnBvc2l0aW9uLnksICJidWxsZXQiLCBudWxsLCB0aGlzLmRlZmF1bHRJbWFnZU9wdGlvbnMpOwogICAgICBidWxsZXQuc2V0Q29sbGlzaW9uQ2F0ZWdvcnkodGhpcy5idWxsZXRzQ2F0ZWdvcnkpOwogICAgICBidWxsZXQuc2V0Q29sbGlkZXNXaXRoKFsxLCB0aGlzLnNoaXBzQ2F0ZWdvcnksIHRoaXMubWFwT2JqZWN0Q2F0ZWdvcnldKTsKICAgICAgYnVsbGV0LnNldE9uQ29sbGlkZShmdW5jdGlvbiAoKSB7CiAgICAgICAgYnVsbGV0LmRlc3Ryb3koKTsKICAgICAgfSk7CiAgICAgIGJ1bGxldC5zZXRBbmdsZShkYXRhLmFuZ2xlKTsKICAgICAgYnVsbGV0LnNldFZlbG9jaXR5KHgsIHkpOwogICAgICBidWxsZXQuc2hvdEJ5ID0gZGF0YS5sb2NhbElkOwogICAgICB0aGlzLnBsYXllcnNbZGF0YS5sb2NhbElkXS5hdmFpbGFibGVCdWxsZXRzLS07CiAgICAgIHRoaXMucGxheWVyc1tkYXRhLmxvY2FsSWRdLmJ1bGxldHNMb2FkZWQua2lsbEZpcnN0QWxpdmUoKTsKICAgICAgdGhpcy5tYXR0ZXIuYm9keS5zZXRJbmVydGlhKGJ1bGxldC5ib2R5LCBJbmZpbml0eSk7CiAgICB9CiAgfSwgewogICAga2V5OiAiY3JlYXRlUG93ZXJVcCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlUG93ZXJVcChkYXRhKSB7CiAgICAgIHZhciBuZXdQb3dlclVwID0gdGhpcy5tYXR0ZXIuYWRkLmltYWdlKGRhdGEucG9zaXRpb24ueCwgZGF0YS5wb3NpdGlvbi55LCBkYXRhLnBvd2VyVXAsIG51bGwsIF9vYmplY3RTcHJlYWQoX29iamVjdFNwcmVhZCh7fSwgdGhpcy5kZWZhdWx0SW1hZ2VPcHRpb25zKSwge30sIHsKICAgICAgICBzaGFwZTogdGhpcy5qc29uU2hhcGVzW2RhdGEucG93ZXJVcF0KICAgICAgfSkpOwoKICAgICAgdmFyIF92ZWxvY2l0eUZyb21BbmdsZTIgPSB2ZWxvY2l0eUZyb21BbmdsZShkYXRhLmFuZ2xlLCB0aGlzLnNldHRpbmdzLnBvd2VyVXBWZWxvY2l0eSksCiAgICAgICAgICB4ID0gX3ZlbG9jaXR5RnJvbUFuZ2xlMi54LAogICAgICAgICAgeSA9IF92ZWxvY2l0eUZyb21BbmdsZTIueTsKCiAgICAgIG5ld1Bvd2VyVXAuc2V0VmVsb2NpdHkoeCwgeSk7CiAgICAgIG5ld1Bvd2VyVXAuc2V0QW5ndWxhclZlbG9jaXR5KHRoaXMuc2V0dGluZ3MucG93ZXJVcEFuZ3VsYXJWZWxvY2l0eSk7CiAgICAgIG5ld1Bvd2VyVXAucG93ZXJVcCA9IGRhdGEucG93ZXJVcDsKICAgICAgbmV3UG93ZXJVcC5zZXRDb2xsaXNpb25DYXRlZ29yeSh0aGlzLnBvd2VyVXBzQ2F0ZWdvcnkpOwogICAgICBuZXdQb3dlclVwLnNldENvbGxpZGVzV2l0aChbMSwgdGhpcy5zaGlwc0NhdGVnb3J5LCB0aGlzLm1hcE9iamVjdENhdGVnb3J5XSk7CiAgICAgIG5ld1Bvd2VyVXAuaWQgPSBkYXRhLmlkOwogICAgICB0aGlzLm1hdHRlci5ib2R5LnNldEluZXJ0aWEobmV3UG93ZXJVcC5ib2R5LCBJbmZpbml0eSk7CiAgICAgIHRoaXMucG93ZXJVcHNPYmplY3RzLnB1c2gobmV3UG93ZXJVcCk7CiAgICB9CiAgfSwgewogICAga2V5OiAiY3JlYXRlTGFzZXIiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGNyZWF0ZUxhc2VyKGRhdGEpIHsKICAgICAgdmFyIF90aGlzNiA9IHRoaXM7CgogICAgICB2YXIgbWF4TGVuZ3RoID0gUGhhc2VyLk1hdGguRGlzdGFuY2UuQmV0d2VlbigwLCAwLCBnYW1lRGltZW5zaW9ucy53aWR0aCwgZ2FtZURpbWVuc2lvbnMuaGVpZ2h0KTsKICAgICAgdmFyIGxhc2VyID0gdGhpcy5tYXR0ZXIuYWRkLmltYWdlKGRhdGEucG9zaXRpb24ueCwgZGF0YS5wb3NpdGlvbi55LCAiYnVsbGV0IiwgbnVsbCwgdGhpcy5kZWZhdWx0SW1hZ2VPcHRpb25zKTsKICAgICAgbGFzZXIuc2hvdEJ5ID0gZGF0YS5sb2NhbElkOwogICAgICBsYXNlci5zZXRTY2FsZShtYXhMZW5ndGggLyBsYXNlci53aWR0aCwgMSk7CiAgICAgIGxhc2VyLnNldFNlbnNvcih0cnVlKTsKICAgICAgbGFzZXIuc2V0QW5nbGUoZGF0YS5hbmdsZSk7CiAgICAgIGxhc2VyLnNldFBvc2l0aW9uKGxhc2VyLnggKyBtYXhMZW5ndGggLyAyICogTWF0aC5jb3MoZGF0YS5hbmdsZSAqIE1hdGguUEkgLyAxODApLCBsYXNlci55ICsgbWF4TGVuZ3RoIC8gMiAqIE1hdGguc2luKGRhdGEuYW5nbGUgKiBNYXRoLlBJIC8gMTgwKSk7CiAgICAgIGxhc2VyLnNldENvbGxpZGVzV2l0aChbdGhpcy5zaGlwc0NhdGVnb3J5LCB0aGlzLm1hcE9iamVjdENhdGVnb3J5XSk7CiAgICAgIGxhc2VyLnNldENvbGxpc2lvbkNhdGVnb3J5KHRoaXMubGFzZXJDYXRlZ29yeSk7CiAgICAgIHRoaXMubWF0dGVyLmJvZHkuc2V0TWFzcyhsYXNlci5ib2R5LCBJbmZpbml0eSk7CiAgICAgIHRoaXMucGxheWVyc1tkYXRhLmxvY2FsSWRdLnNoaXAuc2V0VG9TbGVlcCgpOwogICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICBsYXNlci5kZXN0cm95KCk7CgogICAgICAgIF90aGlzNi5wbGF5ZXJzW2RhdGEubG9jYWxJZF0uc2hpcC5zZXRBd2FrZSgpOwogICAgICB9LCA1MDApOwogICAgfQogIH0sIHsKICAgIGtleTogImdlbmVyYXRlUG93ZXJVcCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZ2VuZXJhdGVQb3dlclVwKF9yZWYpIHsKICAgICAgdmFyIHggPSBfcmVmLngsCiAgICAgICAgICB5ID0gX3JlZi55OwogICAgICB2YXIgbiA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzFdIDogMTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbjsgaSsrKSB7CiAgICAgICAgdmFyIGRhdGEgPSB7CiAgICAgICAgICB0eXBlOiAiY3JlYXRlIiwKICAgICAgICAgIHBvd2VyVXA6IHBvd2VyVXBzW01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIHBvd2VyVXBzLmxlbmd0aCldLAogICAgICAgICAgcG9zaXRpb246IHsKICAgICAgICAgICAgeDogeCB8fCBQaGFzZXIuTWF0aC5GbG9hdEJldHdlZW4oMCwgZ2FtZURpbWVuc2lvbnMud2lkdGgpLAogICAgICAgICAgICB5OiB5IHx8IFBoYXNlci5NYXRoLkZsb2F0QmV0d2VlbigwLCBnYW1lRGltZW5zaW9ucy5oZWlnaHQpCiAgICAgICAgICB9LAogICAgICAgICAgYW5nbGU6IFBoYXNlci5NYXRoLkZsb2F0QmV0d2VlbigwLCAzNjApLAogICAgICAgICAgaWQ6ICsrdGhpcy5wb3dlclVwSWRzCiAgICAgICAgfTsKICAgICAgICB0aGlzLnNvY2tldC5lbWl0KHdlYnNvY2tldEV2ZW50cy5QT1dFUl9VUCwgZGF0YSk7CiAgICAgICAgdGhpcy5wb3dlclVwRXZlbnQoZGF0YSk7CiAgICAgIH0KICAgIH0gLy89PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgLy9PdGhlcnMgZG8gdGhpbmdzIHZpYSB0aGUgd2Vic29ja2V0CgogIH0sIHsKICAgIGtleTogInVwZGF0ZVNoaXAiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHVwZGF0ZVNoaXAoZGF0YSkgewogICAgICB2YXIgcGxheWVyID0gdGhpcy5wbGF5ZXJzW2RhdGFbMF1dOwogICAgICBpZiAoIXBsYXllci5zaGlwKSByZXR1cm47CiAgICAgIHZhciBkZWx0YU1pbGxpc2Vjb25kcyA9IGRhdGFbM10gLSBwbGF5ZXIubGFzdFRpbWVzdGFtcDsKICAgICAgdmFyIGRlbHRhVW5pdHMgPSBkZWx0YU1pbGxpc2Vjb25kcyAqIDYwIC8gMTAwMDsKICAgICAgaWYgKGRlbHRhTWlsbGlzZWNvbmRzIDw9IDApIHJldHVybjsKICAgICAgdmFyIGRlbHRhVGhldGEgPSBkYXRhWzFdIC0gTWF0aC5mbG9vcihwbGF5ZXIuc2hpcC5hbmdsZSk7CiAgICAgIGlmIChkZWx0YVRoZXRhICogTWF0aC5zaWduKHRoaXMuc2V0dGluZ3MuYW5ndWxhclZlbG9jaXR5KSA8IC0xMCkgZGVsdGFUaGV0YSArPSAzNjAgKiBNYXRoLnNpZ24odGhpcy5zZXR0aW5ncy5hbmd1bGFyVmVsb2NpdHkpO2Vsc2UgaWYgKGRlbHRhVGhldGEgKiBNYXRoLnNpZ24odGhpcy5zZXR0aW5ncy5hbmd1bGFyVmVsb2NpdHkpIDwgMCkgZGVsdGFUaGV0YSA9IDA7CiAgICAgIHZhciBhbmd1bGFyVmVsb2NpdHkgPSBkZWx0YVRoZXRhIC8gZGVsdGFVbml0czsKICAgICAgcGxheWVyLnNoaXAuc2V0QW5ndWxhclZlbG9jaXR5KGFuZ3VsYXJWZWxvY2l0eSAqIE1hdGguUEkgLyAxODApOwogICAgICBwbGF5ZXIuc2hpcC5zZXRWZWxvY2l0eSgoZGF0YVsyXVswXSAtIHBsYXllci5zaGlwLngpIC8gZGVsdGFVbml0cywgKGRhdGFbMl1bMV0gLSBwbGF5ZXIuc2hpcC55KSAvIGRlbHRhVW5pdHMpOwogICAgICBwbGF5ZXIubGFzdFRpbWVzdGFtcCA9IGRhdGFbM107CiAgICAgIHBsYXllci5zaGlwLmF1dG9ub215VGltZSA9IGRlbHRhTWlsbGlzZWNvbmRzOwogICAgfQogIH0sIHsKICAgIGtleTogInBvd2VyVXBFdmVudCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gcG93ZXJVcEV2ZW50KGRhdGEpIHsKICAgICAgLy9DcmVhdGUgcG93ZXIgdXAgaXRlbQogICAgICBpZiAoZGF0YS50eXBlID09PSAiY3JlYXRlIikgdGhpcy5jcmVhdGVQb3dlclVwKGRhdGEpOyAvL1BsYXllciBnZXRzIHBvd2VyIHVwCiAgICAgIGVsc2UgaWYgKGRhdGEudHlwZSA9PT0gImdldCIpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5wb3dlclVwc09iamVjdHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIGNoaWxkID0gdGhpcy5wb3dlclVwc09iamVjdHNbaV07CgogICAgICAgICAgICBpZiAoY2hpbGQuaWQgPT09IGRhdGEuaWQpIHsKICAgICAgICAgICAgICB0aGlzLnBvd2VyVXBzT2JqZWN0cyA9IHJlbW92ZUZyb21BcnJheSh0aGlzLnBvd2VyVXBzT2JqZWN0cywgaSk7CiAgICAgICAgICAgICAgY2hpbGQuZGVzdHJveSgpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIGRhdGFUb1NlbmQ7CgogICAgICAgICAgc3dpdGNoIChkYXRhLnBvd2VyVXApIHsKICAgICAgICAgICAgY2FzZSAicmV2ZXJzZSI6CiAgICAgICAgICAgICAgdGhpcy5zZXR0aW5ncy5hbmd1bGFyVmVsb2NpdHkgKj0gLTE7CiAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlICJzaGllbGQiOgogICAgICAgICAgICAgIGRhdGFUb1NlbmQgPSB7CiAgICAgICAgICAgICAgICBsb2NhbElkOiBkYXRhLmxvY2FsSWQsCiAgICAgICAgICAgICAgICBzdGF0ZTogMwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgdGhpcy5zb2NrZXQuZW1pdCh3ZWJzb2NrZXRFdmVudHMuQ0hBTkdFX1NUQVRFLCBkYXRhVG9TZW5kKTsKICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVN0YXRlKGRhdGFUb1NlbmQpOwogICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAicmVsb2FkIjoKICAgICAgICAgICAgICBkYXRhVG9TZW5kID0gewogICAgICAgICAgICAgICAgbG9jYWxJZDogZGF0YS5sb2NhbElkLAogICAgICAgICAgICAgICAgYXZhaWxhYmxlQnVsbGV0czogdGhpcy5tYXhCdWxsZXRzCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB0aGlzLnNvY2tldC5lbWl0KHdlYnNvY2tldEV2ZW50cy5SRUxPQUQsIGRhdGFUb1NlbmQpOwogICAgICAgICAgICAgIHRoaXMucmVsb2FkKGRhdGFUb1NlbmQpOwogICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAibGFzZXIiOgogICAgICAgICAgICAgIHRoaXMucGxheWVyc1tkYXRhLmxvY2FsSWRdLnNoaXAuaGFzTGFzZXIgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0gLy9QbGF5ZXIgdXNlcyBwb3dlciB1cAogICAgICAgIGVsc2UgaWYgKGRhdGEudHlwZSA9PT0gInVzZSIpIHsKICAgICAgICAgICAgaWYgKGRhdGEucG93ZXJVcCA9PT0gImxhc2VyIikgdGhpcy5jcmVhdGVMYXNlcihkYXRhKTsKICAgICAgICAgIH0KICAgIH0gLy89PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgLy9DdXJyZW50IHBsYXllcnMgZG9lcyB0aGluZ3MKCiAgfSwgewogICAga2V5OiAicm90YXRlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiByb3RhdGUoZGVsdGEpIHsKICAgICAgdGhpcy5wbGF5ZXJzW3RoaXMuY3VycmVudFBsYXllcl0uc2hpcC5zZXRBbmdsZSh0aGlzLnBsYXllcnNbdGhpcy5jdXJyZW50UGxheWVyXS5zaGlwLmFuZ2xlICsgZGVsdGEgKiB0aGlzLnNldHRpbmdzLmFuZ3VsYXJWZWxvY2l0eSAqIG1hdHRlck5vcm1hbGl6ZXJzLmFuZ3VsYXJWZWxvY2l0eSk7CiAgICB9CiAgfSwgewogICAga2V5OiAibW92ZUxpdHRsZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gbW92ZUxpdHRsZShkZWx0YSkgewogICAgICB2YXIgY3VycmVudFBsYXllciA9IHRoaXMucGxheWVyc1t0aGlzLmN1cnJlbnRQbGF5ZXJdOwoKICAgICAgaWYgKGN1cnJlbnRQbGF5ZXIuc3RhdGUgPT09IDEpIHsKICAgICAgICB2YXIgc2hpcCA9IGN1cnJlbnRQbGF5ZXIuc2hpcDsKICAgICAgICB2YXIgcHJldmlvdXNNYWcgPSBzaGlwLnZlbG9jaXR5TWFnbml0dWRlOwoKICAgICAgICBpZiAocHJldmlvdXNNYWcgPCB0aGlzLnNldHRpbmdzLm1heFZlbG9jaXR5TGl0dGxlICogbWF0dGVyTm9ybWFsaXplcnMudmVsb2NpdHkpIHsKICAgICAgICAgIGN1cnJlbnRQbGF5ZXIuc2hpcC52ZWxvY2l0eU1hZ25pdHVkZSArPSBkZWx0YSAqIHRoaXMuc2V0dGluZ3MuYWNjZWxlcmF0aW9uTGl0dGxlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjdXJyZW50UGxheWVyLnNoaXAudmVsb2NpdHlNYWduaXR1ZGUgPSB0aGlzLnNldHRpbmdzLm1heFZlbG9jaXR5TGl0dGxlICogbWF0dGVyTm9ybWFsaXplcnMudmVsb2NpdHk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAic2hvb3QiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHNob290KCkgewogICAgICB2YXIgY3VycmVudFBsYXllciA9IHRoaXMucGxheWVyc1t0aGlzLmN1cnJlbnRQbGF5ZXJdOwogICAgICB2YXIgc2hpcCA9IGN1cnJlbnRQbGF5ZXIuc2hpcDsKICAgICAgdmFyIGFuZ2xlID0gc2hpcC5hbmdsZTsKICAgICAgdmFyIGRhdGEgPSB7CiAgICAgICAgcG9zaXRpb246IHsKICAgICAgICAgIHg6IHNoaXAueCArIHNoaXAud2lkdGggKiA1IC8gNCAqIE1hdGguY29zKGFuZ2xlICogTWF0aC5QSSAvIDE4MCksCiAgICAgICAgICB5OiBzaGlwLnkgKyBzaGlwLmhlaWdodCAqIDUgLyA0ICogTWF0aC5zaW4oYW5nbGUgKiBNYXRoLlBJIC8gMTgwKQogICAgICAgIH0sCiAgICAgICAgYW5nbGU6IGFuZ2xlLAogICAgICAgIGxvY2FsSWQ6IHRoaXMuY3VycmVudFBsYXllcgogICAgICB9OwoKICAgICAgaWYgKGN1cnJlbnRQbGF5ZXIuc2hpcC5oYXNMYXNlcikgewogICAgICAgIGRhdGEudHlwZSA9ICJ1c2UiOwogICAgICAgIGRhdGEucG93ZXJVcCA9ICJsYXNlciI7CiAgICAgICAgdGhpcy5zb2NrZXQuZW1pdCh3ZWJzb2NrZXRFdmVudHMuUE9XRVJfVVAsIGRhdGEpOwogICAgICAgIHRoaXMuY3JlYXRlTGFzZXIoZGF0YSk7CiAgICAgICAgY3VycmVudFBsYXllci5zaGlwLmhhc0xhc2VyID0gZmFsc2U7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGN1cnJlbnRQbGF5ZXIuYXZhaWxhYmxlQnVsbGV0cyA+IDApIHsKICAgICAgICAgIHRoaXMuc29ja2V0LmVtaXQod2Vic29ja2V0RXZlbnRzLlNIT09ULCBkYXRhKTsKICAgICAgICAgIHRoaXMuY3JlYXRlQnVsbGV0KGRhdGEpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogInVwZGF0ZVN0YXRlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB1cGRhdGVTdGF0ZShkYXRhKSB7CiAgICAgIHZhciBfdGhpczcgPSB0aGlzOwoKICAgICAgdGhpcy5wbGF5ZXJzW2RhdGEubG9jYWxJZF0uc3RhdGUgPSBkYXRhLnN0YXRlOwogICAgICB2YXIgcGxheWVyID0gdGhpcy5wbGF5ZXJzW2RhdGEubG9jYWxJZF07CgogICAgICBzd2l0Y2ggKGRhdGEuc3RhdGUpIHsKICAgICAgICBjYXNlIDA6CiAgICAgICAgICBwbGF5ZXIuc2hpcC5kZXN0cm95KCk7CiAgICAgICAgICB0aGlzLnBsYXllcnNbZGF0YS5sb2NhbElkXS5idWxsZXRzTG9hZGVkLmtpbGxBbGwoKTsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlIDE6CiAgICAgICAgICBwbGF5ZXIuc2hpcC5zZXRUZXh0dXJlKCJsaXR0bGUiICsgdGhpcy5wbGF5ZXJzW2RhdGEubG9jYWxJZF0uY29sb3IpOwogICAgICAgICAgdGhpcy5wbGF5ZXJzW2RhdGEubG9jYWxJZF0uYnVsbGV0c0xvYWRlZC5raWxsQWxsKCk7CgogICAgICAgICAgaWYgKGRhdGEubG9jYWxJZCA9PT0gdGhpcy5jdXJyZW50UGxheWVyKSB7CiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIGlmIChfdGhpczcucGxheWVyc1tkYXRhLmxvY2FsSWRdLnN0YXRlID09PSAxKSB7CiAgICAgICAgICAgICAgICB2YXIgX2RhdGEgPSB7CiAgICAgICAgICAgICAgICAgIGxvY2FsSWQ6IF90aGlzNy5jdXJyZW50UGxheWVyLAogICAgICAgICAgICAgICAgICBzdGF0ZTogMgogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBfdGhpczcudXBkYXRlU3RhdGUoX2RhdGEpOwoKICAgICAgICAgICAgICAgIF90aGlzNy5zb2NrZXQuZW1pdCh3ZWJzb2NrZXRFdmVudHMuQ0hBTkdFX1NUQVRFLCBfZGF0YSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCB0aGlzLnNldHRpbmdzLnJlc3Bhd25UaW1lKTsKICAgICAgICAgIH0KCiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAyOgogICAgICAgICAgcGxheWVyLnNoaXAudmVsb2NpdHlNYWduaXR1ZGUgPSB0aGlzLnNldHRpbmdzLnZlbG9jaXR5ICogbWF0dGVyTm9ybWFsaXplcnMudmVsb2NpdHk7CiAgICAgICAgICBwbGF5ZXIuc2hpcC5zZXRUZXh0dXJlKCJzaGlwIiArIHRoaXMucGxheWVyc1tkYXRhLmxvY2FsSWRdLmNvbG9yKTsKICAgICAgICAgIHBsYXllci5idWxsZXRzTG9hZGVkLmVuYWJsZUFsbCgpOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgMzoKICAgICAgICAgIHBsYXllci5zaGlwLnZlbG9jaXR5TWFnbml0dWRlID0gdGhpcy5zZXR0aW5ncy52ZWxvY2l0eSAqIG1hdHRlck5vcm1hbGl6ZXJzLnZlbG9jaXR5OwogICAgICAgICAgcGxheWVyLnNoaXAuc2V0VGV4dHVyZSgic2hpZWxkZWQiICsgdGhpcy5wbGF5ZXJzW2RhdGEubG9jYWxJZF0uY29sb3IpOwogICAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICJvbkN1cnJlbnRTaGlwQ29sbGlzaW9uIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBvbkN1cnJlbnRTaGlwQ29sbGlzaW9uKGNvbGxpc2lvbikgewogICAgICB2YXIgcGxheWVyID0gdGhpcy5wbGF5ZXJzW3RoaXMuY3VycmVudFBsYXllcl07CiAgICAgIHZhciBib2R5ID0gZ2V0Qm9keUZyb21Db2xsaXNpb24ocGxheWVyLnNoaXAuYm9keS5pZCwgY29sbGlzaW9uKTsKCiAgICAgIGlmIChib2R5LnBhcmVudC5jb2xsaXNpb25GaWx0ZXIuY2F0ZWdvcnkgPT09IHRoaXMuYnVsbGV0c0NhdGVnb3J5KSB7CiAgICAgICAgLy9jb2xsaXNpb24gd2l0aCBhIGJ1bGxldAogICAgICAgIHRoaXMub25CdWxsZXRDb2xsaXNpb24ocGxheWVyLnNoaXAsIGJvZHkuZ2FtZU9iamVjdCk7CiAgICAgIH0gZWxzZSBpZiAoYm9keS5wYXJlbnQuY29sbGlzaW9uRmlsdGVyLmNhdGVnb3J5ID09PSB0aGlzLnBvd2VyVXBzQ2F0ZWdvcnkpIHsKICAgICAgICAvL0NvbGxpc2lvbiB3aXRoIHBvd2VyIHVwCiAgICAgICAgdGhpcy5vblBvd2VyVXBDb2xsaXNpb24ocGxheWVyLnNoaXAsIGJvZHkuZ2FtZU9iamVjdCk7CiAgICAgIH0gZWxzZSBpZiAoYm9keS5wYXJlbnQuY29sbGlzaW9uRmlsdGVyLmNhdGVnb3J5ID09PSB0aGlzLnNoaXBzQ2F0ZWdvcnkpIHsKICAgICAgICAvL0NvbGxpc2lvbiB3aXRoIHNoaXAKICAgICAgICBpZiAodGhpcy5wbGF5ZXJzW3RoaXMuY3VycmVudFBsYXllcl0uc3RhdGUgPT09IDEgJiYgdGhpcy5wbGF5ZXJzW2JvZHkuZ2FtZU9iamVjdC5sb2NhbElkXS5zdGF0ZSA+PSAyKSB7CiAgICAgICAgICB2YXIgZGF0YSA9IHsKICAgICAgICAgICAgbG9jYWxJZDogdGhpcy5jdXJyZW50UGxheWVyLAogICAgICAgICAgICBzdGF0ZTogMCwKICAgICAgICAgICAga2lsbGVkQnk6IGJvZHkuZ2FtZU9iamVjdC5sb2NhbElkCiAgICAgICAgICB9OwogICAgICAgICAgdGhpcy5zb2NrZXQuZW1pdCh3ZWJzb2NrZXRFdmVudHMuQ0hBTkdFX1NUQVRFLCBkYXRhKTsKICAgICAgICAgIHRoaXMudXBkYXRlU3RhdGUoZGF0YSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGJvZHkucGFyZW50LmNvbGxpc2lvbkZpbHRlci5jYXRlZ29yeSA9PT0gdGhpcy5sYXNlckNhdGVnb3J5KSB7CiAgICAgICAgLy9Db2xsaXNpb24gd2l0aCBsYXNlcgogICAgICAgIHZhciBzdGF0ZSA9IHRoaXMucGxheWVyc1t0aGlzLmN1cnJlbnRQbGF5ZXJdLnN0YXRlIC0gMjsKICAgICAgICB2YXIgX2RhdGEyID0gewogICAgICAgICAgbG9jYWxJZDogdGhpcy5jdXJyZW50UGxheWVyLAogICAgICAgICAgc3RhdGU6IHN0YXRlCiAgICAgICAgfTsKICAgICAgICBpZiAoc3RhdGUgPT09IDApIF9kYXRhMi5raWxsZWRCeSA9IGJvZHkucGFyZW50LmdhbWVPYmplY3Quc2hvdEJ5OwogICAgICAgIHRoaXMuY2xlYXJJbnRlcnZhbHMoZmFsc2UpOwogICAgICAgIHRoaXMuc29ja2V0LmVtaXQod2Vic29ja2V0RXZlbnRzLkNIQU5HRV9TVEFURSwgX2RhdGEyKTsKICAgICAgICB0aGlzLnVwZGF0ZVN0YXRlKF9kYXRhMik7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICJvbkJ1bGxldENvbGxpc2lvbiIsCiAgICB2YWx1ZTogZnVuY3Rpb24gb25CdWxsZXRDb2xsaXNpb24oc2hpcCwgYnVsbGV0KSB7CiAgICAgIHZhciBzdGF0ZSA9IHRoaXMucGxheWVyc1tzaGlwLmxvY2FsSWRdLnN0YXRlIC0gMTsKICAgICAgdmFyIGRhdGEgPSB7CiAgICAgICAgbG9jYWxJZDogc2hpcC5sb2NhbElkLAogICAgICAgIHN0YXRlOiBzdGF0ZQogICAgICB9OwoKICAgICAgaWYgKHN0YXRlID09PSAwKSB7CiAgICAgICAgZGF0YS5raWxsZWRCeSA9IGJ1bGxldC5zaG90Qnk7CiAgICAgICAgdGhpcy5jbGVhckludGVydmFscyhmYWxzZSk7CiAgICAgIH0KCiAgICAgIHRoaXMuc29ja2V0LmVtaXQod2Vic29ja2V0RXZlbnRzLkNIQU5HRV9TVEFURSwgZGF0YSk7CiAgICAgIHRoaXMudXBkYXRlU3RhdGUoZGF0YSk7CiAgICB9CiAgfSwgewogICAga2V5OiAib25Qb3dlclVwQ29sbGlzaW9uIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBvblBvd2VyVXBDb2xsaXNpb24oc2hpcCwgcG93ZXJVcCkgewogICAgICBpZiAodGhpcy5wbGF5ZXJzW3NoaXAubG9jYWxJZF0uc3RhdGUgPCAyKSByZXR1cm47CiAgICAgIHZhciBkYXRhID0gewogICAgICAgIHR5cGU6ICJnZXQiLAogICAgICAgIGxvY2FsSWQ6IHNoaXAubG9jYWxJZCwKICAgICAgICBwb3dlclVwOiBwb3dlclVwLnBvd2VyVXAsCiAgICAgICAgaWQ6IHBvd2VyVXAuaWQKICAgICAgfTsKICAgICAgdGhpcy5zb2NrZXQuZW1pdCh3ZWJzb2NrZXRFdmVudHMuUE9XRVJfVVAsIGRhdGEpOwogICAgICB0aGlzLnBvd2VyVXBFdmVudChkYXRhKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJyZWxvYWQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlbG9hZChkYXRhKSB7CiAgICAgIHRoaXMucGxheWVyc1tkYXRhLmxvY2FsSWRdLmF2YWlsYWJsZUJ1bGxldHMgPSBkYXRhLmF2YWlsYWJsZUJ1bGxldHM7CiAgICAgIHRoaXMucGxheWVyc1tkYXRhLmxvY2FsSWRdLmJ1bGxldHNMb2FkZWQuZW5hYmxlVG8oZGF0YS5hdmFpbGFibGVCdWxsZXRzKTsKICAgIH0gLy89PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgLy9HYW1lIGxvb3AgZnVuY3Rpb25zCgogIH0sIHsKICAgIGtleTogInNldEN1cnJlbnRQbGF5ZXJOZXdWZWxvY2l0eSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2V0Q3VycmVudFBsYXllck5ld1ZlbG9jaXR5KCkgewogICAgICB2YXIgX3ZlbG9jaXR5RnJvbUFuZ2xlMyA9IHZlbG9jaXR5RnJvbUFuZ2xlKHRoaXMucGxheWVyc1t0aGlzLmN1cnJlbnRQbGF5ZXJdLnNoaXAuYW5nbGUsIHRoaXMucGxheWVyc1t0aGlzLmN1cnJlbnRQbGF5ZXJdLnNoaXAudmVsb2NpdHlNYWduaXR1ZGUpLAogICAgICAgICAgeCA9IF92ZWxvY2l0eUZyb21BbmdsZTMueCwKICAgICAgICAgIHkgPSBfdmVsb2NpdHlGcm9tQW5nbGUzLnk7CgogICAgICB0aGlzLnBsYXllcnNbdGhpcy5jdXJyZW50UGxheWVyXS5zaGlwLnNldFZlbG9jaXR5KHgsIHkpOwogICAgfQogIH0sIHsKICAgIGtleTogImRlY2VsZXJhdGVMaXR0bGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGRlY2VsZXJhdGVMaXR0bGUoZGVsdGEpIHsKICAgICAgdGhpcy5wbGF5ZXJzW3RoaXMuY3VycmVudFBsYXllcl0uc2hpcC52ZWxvY2l0eU1hZ25pdHVkZSA9IE1hdGgubWF4KDAsIHRoaXMucGxheWVyc1t0aGlzLmN1cnJlbnRQbGF5ZXJdLnNoaXAudmVsb2NpdHlNYWduaXR1ZGUgLSB0aGlzLnNldHRpbmdzLmZyaWN0aW9uQWlyICogZGVsdGEpOwogICAgfQogIH0sIHsKICAgIGtleTogImdldExvYWRlZEJ1bGxldFBvc2l0aW9uIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRMb2FkZWRCdWxsZXRQb3NpdGlvbihpbmRleCwgdG9wTGVmdCwgYm90dG9tTGVmdCwgY2VudGVyTGVmdCwgcGxheWVyKSB7CiAgICAgIHN3aXRjaCAoaW5kZXgpIHsKICAgICAgICBjYXNlIDA6CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICB4OiBib3R0b21MZWZ0LnggLSBwbGF5ZXIuc2hpcC53aWR0aCAvIDQgKiBNYXRoLmNvcyhwbGF5ZXIuc2hpcC5yb3RhdGlvbiksCiAgICAgICAgICAgIHk6IGJvdHRvbUxlZnQueSAtIHBsYXllci5zaGlwLmhlaWdodCAvIDQgKiBNYXRoLnNpbihwbGF5ZXIuc2hpcC5yb3RhdGlvbikKICAgICAgICAgIH07CgogICAgICAgIGNhc2UgMToKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHg6IHRvcExlZnQueCAtIHBsYXllci5zaGlwLndpZHRoIC8gNCAqIE1hdGguY29zKHBsYXllci5zaGlwLnJvdGF0aW9uKSwKICAgICAgICAgICAgeTogdG9wTGVmdC55IC0gcGxheWVyLnNoaXAuaGVpZ2h0IC8gNCAqIE1hdGguc2luKHBsYXllci5zaGlwLnJvdGF0aW9uKQogICAgICAgICAgfTsKCiAgICAgICAgY2FzZSAyOgogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgeDogY2VudGVyTGVmdC54IC0gcGxheWVyLnNoaXAud2lkdGggLyA0ICogTWF0aC5jb3MocGxheWVyLnNoaXAucm90YXRpb24pLAogICAgICAgICAgICB5OiBjZW50ZXJMZWZ0LnkgLSBwbGF5ZXIuc2hpcC5oZWlnaHQgLyA0ICogTWF0aC5zaW4ocGxheWVyLnNoaXAucm90YXRpb24pCiAgICAgICAgICB9OwogICAgICB9CiAgICB9IC8vPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAgIC8vT24gY3JlYXRlIHNldHVwCgogIH0sIHsKICAgIGtleTogInNldFVwZGF0ZVNoaXBJbnRlcnZhbCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2V0VXBkYXRlU2hpcEludGVydmFsKCkgewogICAgICB2YXIgX3RoaXM4ID0gdGhpczsKCiAgICAgIGlmICh0aGlzLmN1cnJlbnRQbGF5ZXIgPT09IG51bGwpIHJldHVybjsKICAgICAgdmFyIGN1cnJlbnRQbGF5ZXIgPSB0aGlzLnBsYXllcnNbdGhpcy5jdXJyZW50UGxheWVyXTsKICAgICAgdGhpcy51cGRhdGVTaGlwSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbChmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKCFjdXJyZW50UGxheWVyLnNoaXAgfHwgIWN1cnJlbnRQbGF5ZXIuc2hpcC5ib2R5KSByZXR1cm47CgogICAgICAgIF90aGlzOC5zb2NrZXQuZW1pdCh3ZWJzb2NrZXRFdmVudHMuVVBEQVRFX1NISVAsIFtfdGhpczguY3VycmVudFBsYXllciwgTWF0aC5mbG9vcihjdXJyZW50UGxheWVyLnNoaXAuYW5nbGUpLCBbTnVtYmVyLnBhcnNlRmxvYXQoY3VycmVudFBsYXllci5zaGlwLngudG9GaXhlZCgyKSksIE51bWJlci5wYXJzZUZsb2F0KGN1cnJlbnRQbGF5ZXIuc2hpcC55LnRvRml4ZWQoMikpXSwgX3RoaXM4LnRpbWUubm93XSk7CiAgICAgIH0sIDEwMDAgLyB0aGlzLnVwZGF0ZUZwcyk7CiAgICB9CiAgfSwgewogICAga2V5OiAic2V0UmVsb2FkSW50ZXJ2YWwiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHNldFJlbG9hZEludGVydmFsKCkgewogICAgICB2YXIgX3RoaXM5ID0gdGhpczsKCiAgICAgIGlmICh0aGlzLmN1cnJlbnRQbGF5ZXIgPT09IG51bGwpIHJldHVybjsKICAgICAgdGhpcy5yZWxvYWRJbnRlcnZhbCA9IHNldEludGVydmFsKGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoX3RoaXM5LnBsYXllcnNbX3RoaXM5LmN1cnJlbnRQbGF5ZXJdLnN0YXRlIDwgMikgcmV0dXJuOwogICAgICAgIHZhciBhdmFpbGFibGVCdWxsZXRzID0gTWF0aC5taW4oX3RoaXM5Lm1heEJ1bGxldHMsIF90aGlzOS5wbGF5ZXJzW190aGlzOS5jdXJyZW50UGxheWVyXS5hdmFpbGFibGVCdWxsZXRzICsgMSk7CiAgICAgICAgdmFyIGRhdGEgPSB7CiAgICAgICAgICBsb2NhbElkOiBfdGhpczkuY3VycmVudFBsYXllciwKICAgICAgICAgIGF2YWlsYWJsZUJ1bGxldHM6IGF2YWlsYWJsZUJ1bGxldHMKICAgICAgICB9OwoKICAgICAgICBfdGhpczkuc29ja2V0LmVtaXQod2Vic29ja2V0RXZlbnRzLlJFTE9BRCwgZGF0YSk7CgogICAgICAgIF90aGlzOS5yZWxvYWQoZGF0YSk7CiAgICAgIH0sIDEgLyAodGhpcy5zZXR0aW5ncy5yZWxvYWRpbmdWZWxvY2l0eSAqIGFyY2FkZU5vcm1hbGl6ZXJzLnJlbG9hZGluZ1ZlbG9jaXR5KSk7CiAgICB9CiAgfSwgewogICAga2V5OiAic2V0UG93ZXJVcEludGVydmFsIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRQb3dlclVwSW50ZXJ2YWwoKSB7CiAgICAgIHZhciBfdGhpczEwID0gdGhpczsKCiAgICAgIHRoaXMucG93ZXJVcEludGVydmFsID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkgewogICAgICAgIF90aGlzMTAuZ2VuZXJhdGVQb3dlclVwKHt9LCAyKTsKICAgICAgfSwgdGhpcy5wb3dlclVwR2VuZXJhdGlvblRpbWUpOwogICAgfQogIH0sIHsKICAgIGtleTogInNldE9uRGVzdHJveSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2V0T25EZXN0cm95KCkgewogICAgICB2YXIgX3RoaXMxMSA9IHRoaXM7CgogICAgICBpZiAodGhpcy5jdXJyZW50UGxheWVyID09PSBudWxsKSByZXR1cm47CiAgICAgIHRoaXMuZXZlbnRzLm9uKCJkZXN0cm95IiwgZnVuY3Rpb24gKCkgewogICAgICAgIF90aGlzMTEuY2xlYXJJbnRlcnZhbHModHJ1ZSk7CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogImNsZWFySW50ZXJ2YWxzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBjbGVhckludGVydmFscyhwb3dlclVwKSB7CiAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy51cGRhdGVTaGlwSW50ZXJ2YWwpOwogICAgICBjbGVhckludGVydmFsKHRoaXMucmVsb2FkSW50ZXJ2YWwpOwogICAgICBpZiAocG93ZXJVcCAmJiB0aGlzLmN1cnJlbnRQbGF5ZXIgPT09IHRoaXMuYWRtaW4pIGNsZWFySW50ZXJ2YWwodGhpcy5wb3dlclVwSW50ZXJ2YWwpOwogICAgfQogIH0sIHsKICAgIGtleTogInNldFZpc2liaWxpdHlDaGFuZ2VFdmVudCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2V0VmlzaWJpbGl0eUNoYW5nZUV2ZW50KCkgewogICAgICB2YXIgX3RoaXMxMiA9IHRoaXM7CgogICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigidmlzaWJpbGl0eWNoYW5nZSIsIGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoX3RoaXMxMi5zdGF0dXMgLSBNYXRoLmZsb29yKF90aGlzMTIuc3RhdHVzKSA9PT0gMCkgewogICAgICAgICAgaWYgKGRvY3VtZW50LnZpc2liaWxpdHlTdGF0ZSA9PT0gImhpZGRlbiIpIHsKICAgICAgICAgICAgX3RoaXMxMi5zb2NrZXQuY2xvc2UoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIF90aGlzMTIuc29ja2V0Lm9wZW4oKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH1dKTsKCiAgcmV0dXJuIEdhbWVTY2VuZTsKfShQaGFzZXIuU2NlbmUpOwoKZXhwb3J0IHsgR2FtZVNjZW5lIGFzIGRlZmF1bHQgfTs="},{"version":3,"sources":["C:/Users/matte/Desktop/papero/cosmos.papero.me/src/phaser/GameScene.js"],"names":["Phaser","websocketEvents","gameDimensions","arcadeNormalizers","powerUps","sceneKeys","matterNormalizers","detectTouchScreen","removeFromArray","_","createMap","createBulletsLoadedObject","getBodyFromCollision","loadImages","setInputHandlers","velocityFromAngle","GameScene","socket","game","key","physics","default","matter","debug","setBounds","updateFps","touchScreen","defaultImageOptions","friction","frictionAir","frictionStatic","ignoreGravity","maxBullets","powerUpIds","powerUpGenerationTime","setUpGame","on","UPDATE_SHIP","data","updateShip","SHOOT","createBullet","CHANGE_STATE","updateState","RELOAD","reload","POWER_UP","powerUpEvent","END_TURN","setTimeout","clearIntervals","scene","start","ranking","cloneDeep","setVisibilityChangeEvent","status","timer","settings","currentPlayer","admin","map","maxVelocityLittle","velocity","accelerationLittle","respawnTime","powerUpVelocity","powerUpAngularVelocity","players","forEach","player","localId","availableBullets","lastTimestamp","powerUpsObjects","console","log","Object","entries","length","Math","floor","Date","now","stop","values","Physics","Matter","Image","prototype","shapedSetOnCollide","callback","body","parts","part","onCollideCallback","setOnCollide","jsonShapes","cache","json","get","createCategories","createShips","setReloadInterval","setUpdateShipInterval","setPowerUpInterval","generatePowerUp","x","width","y","height","setOnDestroy","time","delta","ship","rotationKey","isDown","rotating","rotate","accelerateLittleKey","accelerating","moveLittle","setCurrentPlayerNewVelocity","state","decelerateLittle","topLeft","getTopLeft","bottomLeft","getBottomLeft","centerLeft","bulletsLoaded","gameObjects","bullet","index","getLoadedBulletPosition","autonomyTime","setVelocity","setAngularVelocity","shipsCategory","bulletsCategory","powerUpsCategory","mapObjectCategory","laserCategory","order","textures","add","image","color","shape","setCollisionCategory","setAngle","velocityMagnitude","setInertia","Infinity","collision","onCurrentShipCollision","angle","bulletVelocity","position","setCollidesWith","destroy","shotBy","killFirstAlive","newPowerUp","powerUp","id","push","maxLength","Distance","Between","laser","setScale","setSensor","setPosition","cos","PI","sin","setMass","setToSleep","setAwake","n","i","type","random","FloatBetween","emit","deltaMilliseconds","deltaUnits","deltaTheta","sign","angularVelocity","createPowerUp","child","dataToSend","hasLaser","createLaser","previousMag","killAll","setTexture","enableAll","parent","collisionFilter","category","onBulletCollision","gameObject","onPowerUpCollision","killedBy","enableTo","max","rotation","updateShipInterval","setInterval","Number","parseFloat","toFixed","reloadInterval","min","reloadingVelocity","powerUpInterval","events","clearInterval","window","addEventListener","document","visibilityState","close","open","Scene"],"mappings":"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","sourcesContent":["import * as Phaser from \"phaser\";\r\nimport websocketEvents from \"../constants/websocketEvents\";\r\nimport {gameDimensions, arcadeNormalizers, powerUps, sceneKeys, matterNormalizers} from \"../constants/gameSettings\";\r\nimport {detectTouchScreen, removeFromArray} from \"../constants/constants\";\r\nimport _ from \"lodash\";\r\nimport createMap from \"../phaser/maps\";\r\n\r\nimport {\r\n    createBulletsLoadedObject,\r\n    getBodyFromCollision,\r\n    loadImages,\r\n    setInputHandlers,\r\n    velocityFromAngle\r\n} from \"./scene\";\r\n\r\n\r\nexport default class GameScene extends Phaser.Scene {\r\n\r\n    setUpGame(game){\r\n        this.status = game.status;\r\n        this.timer = game.timer;\r\n        this.settings = game.settings;\r\n        this.currentPlayer = game.currentPlayer;\r\n        this.admin = game.admin;\r\n        this.map = game.map;\r\n        this.settings.maxVelocityLittle = game.settings.velocity+0.2;\r\n        this.settings.accelerationLittle = 0.1;\r\n        this.settings.respawnTime = 8000;\r\n        this.settings.frictionAir = 0.005;\r\n        this.settings.powerUpVelocity = 3;\r\n        this.settings.powerUpAngularVelocity = 0.1;\r\n        this.players = {};\r\n        game.players.forEach(player => {\r\n            this.players[player.localId] = _.cloneDeep(player);\r\n            this.players[player.localId].availableBullets = this.maxBullets;\r\n            this.players[player.localId].lastTimestamp = 0;\r\n        });\r\n        this.powerUpsObjects = [];\r\n    }\r\n\r\n    constructor(socket, game) {\r\n        super({\r\n            key: sceneKeys.game,\r\n            physics: {\r\n                default: \"matter\",\r\n                matter: {\r\n                    debug: false,\r\n                    setBounds: true\r\n                }\r\n            }\r\n        });\r\n\r\n        this.socket = socket;\r\n\r\n        this.updateFps = 10;\r\n        this.touchScreen = detectTouchScreen();\r\n        this.defaultImageOptions = {friction: 0, frictionAir: 0, frictionStatic: 0, ignoreGravity: true};\r\n        this.maxBullets = 3;\r\n        this.powerUpIds = 0;\r\n        this.powerUpGenerationTime = 10000;\r\n\r\n        this.setUpGame(game);\r\n\r\n        this.socket.on(websocketEvents.UPDATE_SHIP, data => this.updateShip(data));\r\n        this.socket.on(websocketEvents.SHOOT, data => this.createBullet(data));\r\n        this.socket.on(websocketEvents.CHANGE_STATE, data => this.updateState(data));\r\n        this.socket.on(websocketEvents.RELOAD, data => this.reload(data));\r\n        this.socket.on(websocketEvents.POWER_UP, data => this.powerUpEvent(data));\r\n        this.socket.on(websocketEvents.END_TURN, data => {\r\n            setTimeout(()=>{\r\n                this.clearIntervals(true);\r\n                this.scene.start(sceneKeys.ranking, _.cloneDeep(data));\r\n            }, 2000);\r\n        });\r\n\r\n        this.setVisibilityChangeEvent();\r\n    }\r\n\r\n    init(game){\r\n        console.log(\"Game scene init\", _.cloneDeep(game));\r\n        if(Object.entries(game).length>0) this.setUpGame(game);\r\n    }\r\n\r\n    preload(){\r\n        console.log(\"Game scene preload\")\r\n        loadImages(this, sceneKeys.game);\r\n    }\r\n\r\n    create(){\r\n        console.log(\"Game scene create\")\r\n        if(this.status-Math.floor(this.status)===0.5) {\r\n            setTimeout(()=>{\r\n                if(this.timer > Date.now()){\r\n                    this.scene.stop();\r\n                    this.scene.start(sceneKeys.ranking, _.cloneDeep({\r\n                        players: _.cloneDeep(Object.values(this.players)),\r\n                        timer: this.timer\r\n                    }));\r\n                }\r\n            }, 100);\r\n            return;\r\n        }\r\n        console.log(\"continuing create\");\r\n        Phaser.Physics.Matter.Image.prototype.shapedSetOnCollide = function (callback) {\r\n            if (this.body && this.body.parts && this.body.parts.length) {\r\n                for (let part of this.body.parts) {\r\n                    part.onCollideCallback = callback;\r\n                }\r\n            }\r\n            return this.setOnCollide(callback);\r\n        }\r\n\r\n        this.jsonShapes = this.cache.json.get(\"shapes\");\r\n\r\n        this.createCategories();\r\n        this.createShips();\r\n        createMap(this);\r\n\r\n        setInputHandlers(this, sceneKeys.game);\r\n\r\n        this.setReloadInterval();\r\n        this.setUpdateShipInterval();\r\n        if(this.admin === this.currentPlayer){\r\n            this.setPowerUpInterval();\r\n            this.generatePowerUp({x: gameDimensions.width/2, y: gameDimensions.height/2}, 2);\r\n        }\r\n\r\n        this.setOnDestroy();\r\n    }\r\n\r\n    update(time, delta){\r\n        if(this.currentPlayer !== null && this.players[this.currentPlayer].ship && this.players[this.currentPlayer].ship.body) {\r\n            if (this.rotationKey.isDown || this.rotating) this.rotate(delta);\r\n            if (this.accelerateLittleKey.isDown || this.accelerating) this.moveLittle(delta);\r\n\r\n            this.setCurrentPlayerNewVelocity();\r\n            if (this.players[this.currentPlayer].state === 1) this.decelerateLittle(delta);\r\n        }\r\n\r\n        Object.values(this.players).forEach(player => {\r\n            if(!player.ship || !player.ship.body) return;\r\n            const topLeft = player.ship.getTopLeft();\r\n            const bottomLeft = player.ship.getBottomLeft();\r\n            const centerLeft = {\r\n                x: (topLeft.x + bottomLeft.x) / 2,\r\n                y: (topLeft.y + bottomLeft.y) / 2\r\n            }\r\n            player.bulletsLoaded.gameObjects.forEach((bullet, index)=>{\r\n                const {x, y} = this.getLoadedBulletPosition(index, topLeft, bottomLeft, centerLeft, player);\r\n                bullet.x = x;\r\n                bullet.y = y;\r\n            });\r\n            if(player.localId!==this.currentPlayer){\r\n                player.ship.autonomyTime -= delta;\r\n                if(player.ship.autonomyTime<0) {\r\n                    player.ship.setVelocity(0);\r\n                    player.ship.setAngularVelocity(0);\r\n                }\r\n            }\r\n        });\r\n    }\r\n\r\n\r\n\r\n\r\n    //=============================================================================\r\n    //Creating things\r\n    createCategories(){\r\n        this.shipsCategory = 2;\r\n        this.bulletsCategory = 4;\r\n        this.powerUpsCategory = 8;\r\n        this.mapObjectCategory = 16;\r\n        this.laserCategory = 32;\r\n    }\r\n\r\n    createShips(){\r\n        const order = [0, 3, 2, 1];\r\n        let index = 0;\r\n        const textures = [\"\", \"little\", \"ship\", \"shielded\"];\r\n        Object.values(this.players).forEach(player => {\r\n            if(player.state === 0) return;\r\n\r\n            player.ship = this.matter.add.image(\r\n                (order[index]<2 ? 30 : gameDimensions.width-30),\r\n                ( order[index]%2 === 0 ? 30 : gameDimensions.height-30 ),\r\n                textures[player.state]+player.color,\r\n                null,\r\n                {\r\n                    ...this.defaultImageOptions,\r\n                    shape: this.jsonShapes.ship\r\n                }\r\n            );\r\n            player.ship.setCollisionCategory(this.shipsCategory);\r\n            player.ship.setAngle(-45  * ( order[index] < 2 ? 1 : 3) * ( ( order[index] % 2 ) * 2 - 1 ));\r\n            player.ship.velocityMagnitude = this.settings.velocity*matterNormalizers.velocity;\r\n            player.ship.localId = player.localId;\r\n            player.ship.autonomyTime = 0;\r\n            this.matter.body.setInertia(player.ship.body, Infinity);\r\n\r\n            player.bulletsLoaded = createBulletsLoadedObject(this);\r\n\r\n            if(player.localId===this.currentPlayer){\r\n                player.ship.shapedSetOnCollide((collision) => {\r\n                   this.onCurrentShipCollision(collision);\r\n                });\r\n            }\r\n            index++;\r\n        });\r\n    }\r\n\r\n    createBullet(data){\r\n        const {x, y} = velocityFromAngle(data.angle, this.settings.bulletVelocity*matterNormalizers.bulletVelocity);\r\n        const bullet = this.matter.add.image(\r\n            data.position.x,\r\n            data.position.y,\r\n            \"bullet\",\r\n            null,\r\n            this.defaultImageOptions\r\n        );\r\n        bullet.setCollisionCategory(this.bulletsCategory);\r\n        bullet.setCollidesWith([1, this.shipsCategory, this.mapObjectCategory]);\r\n        bullet.setOnCollide(()=>{\r\n            bullet.destroy();\r\n        });\r\n        bullet.setAngle(data.angle);\r\n        bullet.setVelocity(x, y);\r\n        bullet.shotBy = data.localId;\r\n        this.players[data.localId].availableBullets--;\r\n        this.players[data.localId].bulletsLoaded.killFirstAlive();\r\n        this.matter.body.setInertia(bullet.body, Infinity);\r\n    }\r\n\r\n    createPowerUp(data){\r\n        const newPowerUp = this.matter.add.image(data.position.x, data.position.y, data.powerUp, null,\r\n            {\r\n                ...this.defaultImageOptions,\r\n                shape: this.jsonShapes[data.powerUp]\r\n            });\r\n        const {x, y} = velocityFromAngle(data.angle, this.settings.powerUpVelocity);\r\n        newPowerUp.setVelocity(x, y);\r\n        newPowerUp.setAngularVelocity(this.settings.powerUpAngularVelocity);\r\n        newPowerUp.powerUp = data.powerUp;\r\n        newPowerUp.setCollisionCategory(this.powerUpsCategory);\r\n        newPowerUp.setCollidesWith([1, this.shipsCategory, this.mapObjectCategory]);\r\n        newPowerUp.id = data.id;\r\n        this.matter.body.setInertia(newPowerUp.body, Infinity);\r\n        this.powerUpsObjects.push(newPowerUp);\r\n    }\r\n\r\n    createLaser(data){\r\n        const maxLength = Phaser.Math.Distance.Between(0, 0, gameDimensions.width, gameDimensions.height);\r\n        const laser = this.matter.add.image(data.position.x, data.position.y, \"bullet\", null, this.defaultImageOptions);\r\n        laser.shotBy = data.localId;\r\n        laser.setScale(maxLength/laser.width, 1);\r\n        laser.setSensor(true);\r\n        laser.setAngle(data.angle);\r\n        laser.setPosition(laser.x+maxLength/2*Math.cos(data.angle*Math.PI/180), laser.y+maxLength/2*Math.sin(data.angle*Math.PI/180));\r\n        laser.setCollidesWith([this.shipsCategory, this.mapObjectCategory]);\r\n        laser.setCollisionCategory(this.laserCategory);\r\n        this.matter.body.setMass(laser.body, Infinity);\r\n        this.players[data.localId].ship.setToSleep();\r\n        setTimeout(()=>{\r\n            laser.destroy();\r\n            this.players[data.localId].ship.setAwake();\r\n        }, 500);\r\n    }\r\n\r\n    generatePowerUp({x, y}, n=1){\r\n        for(let i = 0; i < n; i++){\r\n            const data = {\r\n                type: \"create\",\r\n                powerUp: powerUps[Math.floor(Math.random()*powerUps.length)],\r\n                position: {\r\n                    x: x || Phaser.Math.FloatBetween(0, gameDimensions.width),\r\n                    y: y || Phaser.Math.FloatBetween(0, gameDimensions.height)\r\n                },\r\n                angle: Phaser.Math.FloatBetween(0, 360),\r\n                id: ++this.powerUpIds\r\n            }\r\n            this.socket.emit(websocketEvents.POWER_UP, data);\r\n            this.powerUpEvent(data);\r\n        }\r\n    }\r\n\r\n\r\n\r\n\r\n    //=============================================================================\r\n    //Others do things via the websocket\r\n    updateShip(data){\r\n        const player = this.players[data[0]];\r\n        if(!player.ship) return;\r\n        const deltaMilliseconds = (data[3]-player.lastTimestamp);\r\n        const deltaUnits = deltaMilliseconds*60/1000;\r\n        if(deltaMilliseconds<=0) return;\r\n\r\n        let deltaTheta = data[1] - Math.floor(player.ship.angle);\r\n\r\n        if(deltaTheta*Math.sign(this.settings.angularVelocity) < -10) deltaTheta += 360*Math.sign(this.settings.angularVelocity);\r\n        else if(deltaTheta*Math.sign(this.settings.angularVelocity) < 0) deltaTheta = 0;\r\n        const angularVelocity = deltaTheta / deltaUnits;\r\n        player.ship.setAngularVelocity(angularVelocity * Math.PI / 180);\r\n        player.ship.setVelocity( ( data[2][0]-player.ship.x ) / deltaUnits, ( data[2][1]-player.ship.y ) / deltaUnits );\r\n\r\n        player.lastTimestamp = data[3];\r\n        player.ship.autonomyTime = deltaMilliseconds;\r\n    }\r\n\r\n    powerUpEvent(data){\r\n        //Create power up item\r\n        if(data.type === \"create\") this.createPowerUp(data);\r\n        //Player gets power up\r\n        else if(data.type === \"get\") {\r\n            for(let i=0; i<this.powerUpsObjects.length; i++){\r\n                const child = this.powerUpsObjects[i];\r\n                if(child.id === data.id){\r\n                    this.powerUpsObjects = removeFromArray(this.powerUpsObjects, i);\r\n                    child.destroy();\r\n                    break;\r\n                }\r\n            }\r\n            let dataToSend;\r\n            switch (data.powerUp){\r\n                case \"reverse\":\r\n                    this.settings.angularVelocity *= -1;\r\n                    break;\r\n                case \"shield\":\r\n                    dataToSend = {\r\n                        localId: data.localId,\r\n                        state: 3\r\n                    }\r\n                    this.socket.emit(websocketEvents.CHANGE_STATE, dataToSend);\r\n                    this.updateState(dataToSend);\r\n                    break;\r\n                case \"reload\":\r\n                    dataToSend = {\r\n                        localId: data.localId,\r\n                        availableBullets: this.maxBullets\r\n                    };\r\n                    this.socket.emit(websocketEvents.RELOAD, dataToSend);\r\n                    this.reload(dataToSend);\r\n                    break;\r\n                case \"laser\":\r\n                    this.players[data.localId].ship.hasLaser = true;\r\n            }\r\n        }\r\n        //Player uses power up\r\n        else if(data.type === \"use\") {\r\n            if (data.powerUp === \"laser\") this.createLaser(data);\r\n        }\r\n    }\r\n\r\n\r\n\r\n    //=============================================================================\r\n    //Current players does things\r\n    rotate(delta){\r\n        this.players[this.currentPlayer].ship.setAngle(\r\n            this.players[this.currentPlayer].ship.angle + delta * this.settings.angularVelocity * matterNormalizers.angularVelocity\r\n        );\r\n    }\r\n\r\n    moveLittle(delta){\r\n        const currentPlayer = this.players[this.currentPlayer];\r\n        if(currentPlayer.state === 1){\r\n            const ship = currentPlayer.ship;\r\n            const previousMag = ship.velocityMagnitude;\r\n            if(previousMag < this.settings.maxVelocityLittle * matterNormalizers.velocity){\r\n                currentPlayer.ship.velocityMagnitude += delta*this.settings.accelerationLittle;\r\n            } else {\r\n                currentPlayer.ship.velocityMagnitude = this.settings.maxVelocityLittle * matterNormalizers.velocity;\r\n            }\r\n        }\r\n    }\r\n\r\n    shoot(){\r\n        const currentPlayer = this.players[this.currentPlayer];\r\n        const ship = currentPlayer.ship;\r\n        const angle = ship.angle;\r\n        const data = {\r\n            position: {\r\n                x: ship.x + ship.width*5/4*Math.cos(angle * Math.PI / 180),\r\n                y: ship.y + ship.height*5/4*Math.sin(angle * Math.PI / 180)\r\n            },\r\n            angle: angle,\r\n            localId: this.currentPlayer\r\n        };\r\n        if(currentPlayer.ship.hasLaser){\r\n            data.type = \"use\";\r\n            data.powerUp = \"laser\";\r\n            this.socket.emit(websocketEvents.POWER_UP, data);\r\n            this.createLaser(data);\r\n            currentPlayer.ship.hasLaser = false;\r\n        } else {\r\n            if(currentPlayer.availableBullets>0){\r\n                this.socket.emit(websocketEvents.SHOOT, data);\r\n                this.createBullet(data);\r\n            }\r\n        }\r\n    }\r\n\r\n\r\n    updateState(data){\r\n        this.players[data.localId].state = data.state;\r\n        const player = this.players[data.localId];\r\n        switch (data.state) {\r\n            case 0:\r\n                player.ship.destroy();\r\n                this.players[data.localId].bulletsLoaded.killAll();\r\n                break;\r\n            case 1:\r\n                player.ship.setTexture(\"little\" + this.players[data.localId].color);\r\n                this.players[data.localId].bulletsLoaded.killAll();\r\n                if(data.localId === this.currentPlayer) {\r\n                    setTimeout(() => {\r\n                        if (this.players[data.localId].state === 1) {\r\n                            const data = {\r\n                                localId: this.currentPlayer,\r\n                                state: 2\r\n                            };\r\n                            this.updateState(data);\r\n                            this.socket.emit(websocketEvents.CHANGE_STATE, data);\r\n                        }\r\n                    }, this.settings.respawnTime);\r\n                }\r\n                break;\r\n            case 2:\r\n                player.ship.velocityMagnitude = this.settings.velocity * matterNormalizers.velocity;\r\n                player.ship.setTexture(\"ship\" + this.players[data.localId].color);\r\n                player.bulletsLoaded.enableAll();\r\n                break;\r\n            case 3:\r\n                player.ship.velocityMagnitude = this.settings.velocity * matterNormalizers.velocity;\r\n                player.ship.setTexture(\"shielded\" + this.players[data.localId].color);\r\n                break;\r\n        }\r\n    }\r\n\r\n    onCurrentShipCollision(collision) {\r\n        const player = this.players[this.currentPlayer];\r\n        const body = getBodyFromCollision(player.ship.body.id, collision);\r\n        if(body.parent.collisionFilter.category === this.bulletsCategory){\r\n            //collision with a bullet\r\n            this.onBulletCollision(player.ship, body.gameObject);\r\n        } else if(body.parent.collisionFilter.category === this.powerUpsCategory){\r\n            //Collision with power up\r\n            this.onPowerUpCollision(player.ship, body.gameObject);\r\n        } else if(body.parent.collisionFilter.category === this.shipsCategory){\r\n            //Collision with ship\r\n            if(this.players[this.currentPlayer].state === 1 && this.players[body.gameObject.localId].state >= 2){\r\n                const data = {\r\n                    localId: this.currentPlayer,\r\n                    state: 0,\r\n                    killedBy: body.gameObject.localId\r\n                };\r\n                this.socket.emit(websocketEvents.CHANGE_STATE, data);\r\n                this.updateState(data);\r\n            }\r\n        } else if(body.parent.collisionFilter.category === this.laserCategory){\r\n            //Collision with laser\r\n            const state = this.players[this.currentPlayer].state-2;\r\n            const data = {\r\n                localId: this.currentPlayer,\r\n                state\r\n            };\r\n            if(state===0) data.killedBy= body.parent.gameObject.shotBy;\r\n            this.clearIntervals(false);\r\n            this.socket.emit(websocketEvents.CHANGE_STATE, data);\r\n            this.updateState(data);\r\n        }\r\n    }\r\n\r\n    onBulletCollision(ship, bullet){\r\n        const state = this.players[ship.localId].state-1;\r\n        const data = {\r\n            localId: ship.localId,\r\n            state\r\n        };\r\n        if(state === 0) {\r\n            data.killedBy = bullet.shotBy;\r\n            this.clearIntervals(false);\r\n        }\r\n        this.socket.emit(websocketEvents.CHANGE_STATE, data);\r\n        this.updateState(data);\r\n    }\r\n\r\n    onPowerUpCollision(ship, powerUp){\r\n        if(this.players[ship.localId].state < 2 ) return;\r\n        const data = {\r\n            type: \"get\",\r\n            localId: ship.localId,\r\n            powerUp: powerUp.powerUp,\r\n            id: powerUp.id\r\n        }\r\n        this.socket.emit(websocketEvents.POWER_UP, data);\r\n        this.powerUpEvent(data);\r\n    }\r\n\r\n    reload(data){\r\n        this.players[data.localId].availableBullets = data.availableBullets;\r\n        this.players[data.localId].bulletsLoaded.enableTo(data.availableBullets);\r\n    }\r\n\r\n\r\n    //=============================================================================\r\n    //Game loop functions\r\n    setCurrentPlayerNewVelocity(){\r\n        const {x, y} = velocityFromAngle(\r\n            this.players[this.currentPlayer].ship.angle,\r\n            this.players[this.currentPlayer].ship.velocityMagnitude\r\n        );\r\n        this.players[this.currentPlayer].ship.setVelocity(x, y);\r\n    }\r\n\r\n    decelerateLittle(delta){\r\n        this.players[this.currentPlayer].ship.velocityMagnitude = Math.max(\r\n            0, this.players[this.currentPlayer].ship.velocityMagnitude - this.settings.frictionAir * delta\r\n        );\r\n    }\r\n\r\n    getLoadedBulletPosition(index, topLeft, bottomLeft, centerLeft, player){\r\n        switch (index){\r\n            case 0:\r\n                return {\r\n                    x: bottomLeft.x - (player.ship.width/4)*Math.cos(player.ship.rotation),\r\n                    y: bottomLeft.y - (player.ship.height/4)*Math.sin(player.ship.rotation)\r\n                };\r\n            case 1:\r\n                return{\r\n                    x: topLeft.x - (player.ship.width/4)*Math.cos(player.ship.rotation),\r\n                    y: topLeft.y - (player.ship.height/4)*Math.sin(player.ship.rotation)\r\n                };\r\n            case 2:\r\n                return {\r\n                    x: centerLeft.x - (player.ship.width/4)*Math.cos(player.ship.rotation),\r\n                    y: centerLeft.y - (player.ship.height/4)*Math.sin(player.ship.rotation)\r\n                };\r\n        }\r\n    }\r\n\r\n\r\n\r\n    //=============================================================================\r\n    //On create setup\r\n    setUpdateShipInterval(){\r\n        if(this.currentPlayer === null) return;\r\n\r\n        const currentPlayer = this.players[this.currentPlayer];\r\n        this.updateShipInterval = setInterval(()=>{\r\n            if(!currentPlayer.ship || !currentPlayer.ship.body) return;\r\n            this.socket.emit(websocketEvents.UPDATE_SHIP, [\r\n                this.currentPlayer,\r\n                Math.floor(currentPlayer.ship.angle),\r\n                [\r\n                    Number.parseFloat(currentPlayer.ship.x.toFixed(2)),\r\n                    Number.parseFloat(currentPlayer.ship.y.toFixed(2))\r\n                ],\r\n                this.time.now\r\n            ]);\r\n        }, 1000/this.updateFps);\r\n    }\r\n\r\n    setReloadInterval(){\r\n        if(this.currentPlayer === null) return;\r\n\r\n        this.reloadInterval = setInterval(() => {\r\n            if(this.players[this.currentPlayer].state<2) return;\r\n            const availableBullets = Math.min(this.maxBullets, this.players[this.currentPlayer].availableBullets + 1);\r\n            const data = {\r\n                localId: this.currentPlayer,\r\n                availableBullets\r\n            };\r\n            this.socket.emit(websocketEvents.RELOAD, data);\r\n            this.reload(data);\r\n        }, 1/(this.settings.reloadingVelocity * arcadeNormalizers.reloadingVelocity));\r\n    }\r\n\r\n    setPowerUpInterval(){\r\n        this.powerUpInterval = setInterval(()=>{\r\n            this.generatePowerUp({}, 2);\r\n        }, this.powerUpGenerationTime);\r\n    }\r\n\r\n    setOnDestroy(){\r\n        if(this.currentPlayer === null) return;\r\n\r\n        this.events.on(\"destroy\", ()=>{\r\n            this.clearIntervals(true);\r\n        });\r\n    }\r\n\r\n    clearIntervals(powerUp){\r\n        clearInterval(this.updateShipInterval);\r\n        clearInterval(this.reloadInterval);\r\n        if(powerUp && this.currentPlayer===this.admin) clearInterval(this.powerUpInterval);\r\n    }\r\n\r\n    setVisibilityChangeEvent() {\r\n        window.addEventListener(\"visibilitychange\", () => {\r\n            if(this.status-Math.floor(this.status)===0){\r\n                if(document.visibilityState === \"hidden\"){\r\n                    this.socket.close();\r\n                } else {\r\n                    this.socket.open();\r\n                }\r\n            }\r\n        });\r\n    }\r\n}"]}]}